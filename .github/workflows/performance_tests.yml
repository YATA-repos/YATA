name: Performance Regression Tests

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]
  schedule:
    # æ¯æ—¥åˆå‰2æ™‚ï¼ˆJSTï¼‰ã«å®šæœŸå®Ÿè¡Œ
    - cron: '0 17 * * *'  # UTC 17:00 = JST 02:00

jobs:
  performance-tests:
    name: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å›å¸°ãƒ†ã‚¹ãƒˆ
    runs-on: ubuntu-latest
    timeout-minutes: 30

    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: Flutterç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        cache: true

    - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: |
        flutter --version
        flutter pub get

    - name: ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚’å®Ÿè¡Œ
      run: |
        dart run build_runner build --delete-conflicting-outputs

    - name: æ—¢å­˜ã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã‚’å¾©å…ƒ
      uses: actions/cache@v4
      with:
        path: |
          performance_baseline.json
          performance_results.json
        key: performance-baseline-${{ github.repository }}-${{ github.ref }}
        restore-keys: |
          performance-baseline-${{ github.repository }}-
          performance-baseline-

    - name: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
      run: |
        echo "ğŸš€ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å›å¸°ãƒ†ã‚¹ãƒˆé–‹å§‹"
        dart test/performance/run_performance_tests.dart \
          --regression-threshold=25.0 \
          --no-update-baseline
      continue-on-error: true
      id: performance_tests

    - name: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆçµæœã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: performance-test-results
        path: |
          performance_test_results.xml
          performance_detailed_report.json
          performance_results.json
        retention-days: 30

    - name: JUnitãƒ†ã‚¹ãƒˆçµæœã‚’å…¬é–‹
      uses: dorny/test-reporter@v1
      if: always()
      with:
        name: Performance Test Results
        path: performance_test_results.xml
        reporter: java-junit
        fail-on-error: false

    - name: ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å›å¸°ã‚¢ãƒ©ãƒ¼ãƒˆ
      if: failure()
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          try {
            // è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆã‚’èª­ã¿è¾¼ã¿
            const reportData = fs.readFileSync('performance_detailed_report.json', 'utf8');
            const report = JSON.parse(reportData);
            
            // å›å¸°ãŒæ¤œå‡ºã•ã‚ŒãŸå ´åˆã®å‡¦ç†
            if (report.regressionCount > 0) {
              const regressionDetails = report.regressions.map(r => 
                `- **${r.testName}**: ${r.reason}\n  - å®Ÿè¡Œæ™‚é–“: ${r.executionTimeRegressionPercent.toFixed(1)}%\n  - ãƒ¡ãƒ¢ãƒª: ${r.memoryRegressionPercent.toFixed(1)}%`
              ).join('\n');

              const issueBody = `## ğŸš¨ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å›å¸°æ¤œå‡º

**ãƒ–ãƒ©ãƒ³ãƒ**: ${process.env.GITHUB_REF}
**ã‚³ãƒŸãƒƒãƒˆ**: ${process.env.GITHUB_SHA}
**å®Ÿè¡Œæ™‚åˆ»**: ${new Date().toISOString()}

### ğŸ“Š ãƒ†ã‚¹ãƒˆçµæœã‚µãƒãƒªãƒ¼
- ç·ãƒ†ã‚¹ãƒˆæ•°: ${report.totalTests}
- æˆåŠŸ: ${report.passedTests}
- å¤±æ•—: ${report.failedTests}
- **å›å¸°æ¤œå‡º: ${report.regressionCount}**

### ğŸ” æ¤œå‡ºã•ã‚ŒãŸå›å¸°
${regressionDetails}

### ğŸ“ˆ å¯¾å¿œæ–¹æ³•
1. å¤‰æ›´å†…å®¹ã‚’ç¢ºèªã—ã€ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã«å½±éŸ¿ã™ã‚‹ä¿®æ­£ãŒãªã„ã‹æ¤œè¨¼ã—ã¦ãã ã•ã„
2. å¿…è¦ã«å¿œã˜ã¦ã‚³ãƒ¼ãƒ‰ã‚’æœ€é©åŒ–ã—ã¦ãã ã•ã„
3. æ„å›³çš„ãªå¤‰æ›´ã®å ´åˆã¯ã€ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã‚’æ›´æ–°ã—ã¦ãã ã•ã„

---
*This issue was automatically created by the performance regression detection system.*`;

              // Issueã‚’ä½œæˆ
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `ğŸš¨ ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹å›å¸°æ¤œå‡º - ${new Date().toISOString().split('T')[0]}`,
                body: issueBody,
                labels: ['performance', 'regression', 'automated']
              });
            }
          } catch (error) {
            console.log('ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', error.message);
          }

    - name: PRç”¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚³ãƒ¡ãƒ³ãƒˆ
      if: github.event_name == 'pull_request'
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          try {
            const reportData = fs.readFileSync('performance_detailed_report.json', 'utf8');
            const report = JSON.parse(reportData);
            
            const statusEmoji = report.success ? 'âœ…' : 'âŒ';
            const regressionEmoji = report.regressionCount > 0 ? 'ğŸš¨' : 'âœ…';
            
            const commentBody = `## ${statusEmoji} ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆçµæœ

### ğŸ“Š ãƒ†ã‚¹ãƒˆ ã‚µãƒãƒªãƒ¼
- **ç·ãƒ†ã‚¹ãƒˆæ•°**: ${report.totalTests}
- **æˆåŠŸ**: ${report.passedTests}
- **å¤±æ•—**: ${report.failedTests}
- **å®Ÿè¡Œæ™‚é–“**: ${report.executionTimeMs}ms

### ${regressionEmoji} å›å¸°æ¤œå‡º
- **æ¤œå‡ºæ•°**: ${report.regressionCount}

${report.regressionCount > 0 ? `
#### æ¤œå‡ºã•ã‚ŒãŸå›å¸°
${report.regressions.map(r => `- **${r.testName}**: ${r.reason}`).join('\n')}
` : ''}

### ğŸ“ˆ è©³ç´°çµæœ
è©³ç´°ãªçµæœã¯ [Artifacts](${process.env.GITHUB_SERVER_URL}/${process.env.GITHUB_REPOSITORY}/actions/runs/${process.env.GITHUB_RUN_ID}) ã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚

---
*Performance tests run at ${new Date().toISOString()}*`;

            // PR ã«ã‚³ãƒ¡ãƒ³ãƒˆè¿½åŠ 
            await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: commentBody
            });
          } catch (error) {
            console.log('ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ¬ãƒãƒ¼ãƒˆãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“:', error.message);
          }

  # ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³æ›´æ–°ã‚¸ãƒ§ãƒ–ï¼ˆmainãƒ–ãƒ©ãƒ³ãƒã®ã¿ï¼‰
  update-baseline:
    name: ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³æ›´æ–°
    runs-on: ubuntu-latest
    needs: performance-tests
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
    - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
      uses: actions/checkout@v4

    - name: Flutterç’°å¢ƒã‚’ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—
      uses: subosito/flutter-action@v2
      with:
        flutter-version: '3.24.0'
        channel: 'stable'
        cache: true

    - name: ä¾å­˜é–¢ä¿‚ã‚’ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«
      run: flutter pub get

    - name: ã‚³ãƒ¼ãƒ‰ç”Ÿæˆã‚’å®Ÿè¡Œ
      run: dart run build_runner build --delete-conflicting-outputs

    - name: ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³æ›´æ–°ç”¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ
      run: |
        echo "ğŸ“Š ãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³æ›´æ–°ç”¨ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå®Ÿè¡Œ"
        dart test/performance/run_performance_tests.dart \
          --regression-threshold=50.0 \
          --update-baseline

    - name: æ›´æ–°ã•ã‚ŒãŸãƒ™ãƒ¼ã‚¹ãƒ©ã‚¤ãƒ³ã‚’ã‚³ãƒŸãƒƒãƒˆ
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        if [ -f "performance_baseline.json" ]; then
          git add performance_baseline.json
          git commit -m "chore: update performance baseline [skip ci]" || exit 0
          git push
        fi