# Windows UIスケーリング代替アプローチ 工数調査

- 作成日: 2025-10-09
- 作成者: GitHub Copilot
- 対象ブランチ: `dev`

本ドキュメントでは、レスポンシブ再設計 (約 18.8 人日/Most) 以外に検討できる UI スケーリング対策を整理し、各アプローチの作業項目・工数・リスクを比較する。

## 1. 対象アプローチ概要
| No. | アプローチ | 概要 | 主な変更箇所 |
| --- | --- | --- | --- |
| A | アプリ側で MediaQuery をラップして縮小係数を適用 | Windows 判定時に `MaterialApp.builder` で `MediaQuery` を上書きし、全体レイアウトを強制的に縮小する | `lib/app/app.dart`、任意の設定管理層 |
| B | Windows ランナーで DPI スケーリングを固定化 | `Win32Window::Create` の `Scale` 呼び出しを 1.0 に固定し、OS からの高 DPI 指示を無効化 | `windows/runner/win32_window.cpp`、必要に応じて `runner.exe.manifest` |
| C | Windows 向けにデザイン・トークンを縮小 | `YataSpacingTokens` やタイポグラフィ、トークン経由の余白/フォントを Windows のみ縮小する | `lib/shared/foundations/tokens/*.dart`、関連コンポーネント |

## 2. アプローチ別詳細

### A. MediaQuery 差し替えによる画面全体縮小
**想定作業:**
1. `YataApp` (`lib/app/app.dart`) の `MaterialApp.router` に `builder` を追加し、Windows 判定 (`Platform.isWindows`) 時に `MediaQuery` を複製。
2. `devicePixelRatio`/`textScaler`/`size` を調整し、`Transform.scale` で論理レイアウト全体を縮小。
3. 縮小率の設定値を定数 or 設定ファイル化し、将来的な調整を容易に。
4. 主要画面 (注文、在庫、分析) で UI 崩れがないか目視確認。
5. 入力可能ウィジェットでフォーカス/カーソル位置のズレ有無を検証。

| 作業カテゴリ | Best (人日) | Most (人日) | Worst (人日) |
| --- | --- | --- | --- |
| 実装 (builder 追加、縮小係数適用) | 0.4 | 0.6 | 0.9 |
| 縮小率調整・設定化 | 0.2 | 0.4 | 0.6 |
| 主要画面 QA (Windows: 100/125/150%) | 0.6 | 0.8 | 1.2 |
| 雑多な調整 (フォーカス、スクロール) | 0.2 | 0.4 | 0.6 |
| **合計** | **1.4** | **2.2** | **3.3** |

**リスク / 留意点:**
- OS が渡す DPI を偽装するため、フォントのレンダリングがぼやける可能性。
- `Transform.scale` 併用によってヒットテスト/ポインタ座標のずれが発生するケースがある。
- アクセシビリティ (スクリーンリーダー、フォントサイズ変更) への影響を要確認。

**適用目安:**
短期間で “見た目のサイズ” だけ抑えたい場合の暫定策。品質保証に時間を割けるなら Most で約 2.2 人日。

---

### B. Windows ランナーで DPI スケールを固定
**想定作業:**
1. `windows/runner/win32_window.cpp` 内 `Win32Window::Create` の `Scale(origin.x, scale_factor)` 等を `scale_factor = 1.0` 固定に変更。
2. `WM_DPICHANGED` メッセージでのリサイズ処理を確認し、不要であれば無効化。
3. DPI 固定後のぼやけ対策として `runner.exe.manifest` の `dpiAwareness` を `PerMonitorV2` → `System` などに変更検討。
4. 変更が他 OS に影響しないかビルド確認。
5. Windows 上で 100%/125%/150% 表示時の描画鮮明度・スクロール滑らかさを確認。

| 作業カテゴリ | Best (人日) | Most (人日) | Worst (人日) |
| --- | --- | --- | --- |
| 実装 (Win32Window 修正) | 0.2 | 0.3 | 0.5 |
| マニフェスト調整・ビルド確認 | 0.2 | 0.3 | 0.5 |
| 表示品質 QA (鮮明度/ぼやけ確認) | 0.4 | 0.6 | 0.9 |
| フォールバック検討 (元へ戻すオプション) | 0.1 | 0.2 | 0.4 |
| **合計** | **0.9** | **1.4** | **2.3** |

**リスク / 留意点:**
- 高 DPI 環境での描画が OS のアップスケール頼りになるため、フォントやラインがぼやける可能性大。
- 将来の Windows DPI 改善（周辺モニター構成）に追従しづらい。
- Linux/macOS には影響しないが、Flutter の Windows ビルド更新時にコンフリクトが生じるリスク。

**適用目安:**
短時間で “見た目を Linux 相当に近づけたい” 場合。ただし UI 品質が犠牲になる前提で、Most 約 1.4 人日。

---

### C. Windows 向けデザイン・トークン縮小
**想定作業:**
1. `YataSpacingTokens`、`YataTypographyTokens` 等に Windows 判定を追加し、小さいスケールの値を返す。(例: `spacingMultiplier` を追加してプラットフォーム別係数を掛ける)
2. 該当トークンを利用するコンポーネント (`YataPageContainer`, `YataSectionCard`, ナビゲーション等) が、新しい API に追随できるよう軽微な修正。
3. 主要画面での余白/フォントのバランス調整。
4. QA と細部調整 (レイアウト崩れやボタンのタップ領域縮小をチェック)。

| 作業カテゴリ | Best (人日) | Most (人日) | Worst (人日) |
| --- | --- | --- | --- |
| トークン設計・実装 | 0.4 | 0.6 | 0.9 |
| 主要コンポーネント適用 (`PageContainer`, `TopBar`, `SectionCard`) | 0.6 | 0.9 | 1.2 |
| 画面別微調整 (注文・在庫・メニュー・履歴) | 1.2 | 1.6 | 2.2 |
| QA・タップ領域確認 | 0.4 | 0.6 | 0.9 |
| **合計** | **2.6** | **3.7** | **5.2** |

**リスク / 留意点:**
- トークンが減少した分だけ、要素密度が高まり操作性が悪化する恐れ。
- 既存のレスポンシブ設計が不足している状態で余白だけを詰めると、テーブルやグリッドが詰まり過ぎる可能性。
- 将来的にレスポンシブ化へ移行する際、二重の調整が必要になる。

**適用目安:**
レスポンシブ化ほど大規模ではないが、全画面への波及を伴うため Most 約 3.7 人日。単独開発でも現実的なボリューム。

## 3. アプローチ比較まとめ
| 指標 | A: MediaQuery差し替え | B: Win32スケール固定 | C: トークン縮小 |
| --- | --- | --- | --- |
| 作業規模 (Most) | 2.2 人日 | **1.4 人日 (最小)** | 3.7 人日 |
| 品質リスク | ヒットテスト/フォーカスズレ、フォントぼやけ | 高 DPI でのぼやけ、将来互換性 | 操作性悪化、二重調整 |
| 再利用性/拡張性 | 低 (暫定対策) | 低 (Windows専用オプション) | 中 (プラットフォーム別トークンとして残せる) |
| 実装難度 | 中 (Flutter側で完結) | 低 (C++修正) | 中 (全画面への影響) |
| 将来レスポンシブ化への足掛かり | 乏しい | 乏しい | 一部流用可 (トークンベース設計) |

## 4. 推奨と所感
- **短期的に見栄えだけ合わせたい場合は B** が最も低コスト。ただし高 DPI 環境でのぼやけは避けられず、顧客体験を損なう恐れがある。
- **UI 品質を大きく落とさず手早く対応したい場合は A**。Most 2.2 人日で導入できるが、ヒットテストや IME カーソル位置の検証が必須。
- **将来のレスポンシブ設計に繋げたい場合は C**。工数は増えるものの、デザインシステム観点の投資になり、追加でレスポンシブ化を進める際の足掛かりとなる。

単独開発体制を考慮すると、短期リリースを目指す場合は A or B をベースにした暫定対応 + 後続でレスポンシブ計画 (既存調査) を進める 2 段階アプローチが現実的である。