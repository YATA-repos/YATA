# 在庫・メニュー検索カテゴリ対応実装計画 (2025-10-13)

## 1. 背景
- 在庫管理画面およびメニュー管理画面の検索フィールドは、現状SKU名・メニュー名など一部フィールドのみを対象にしている。
- カテゴリ階層（在庫カテゴリ・メニューカテゴリ）によるフィルタリングができず、カテゴリ単位で在庫確認やメニュー整理を行う店舗オペレーションに負担が生じている。
- バックエンド（Supabase）およびアプリ内データモデルのカテゴリ情報は保持されているため、検索対象に追加することでUX改善が見込める。

## 2. 目的
1. 在庫管理画面とメニュー管理画面の検索フィールドでカテゴリ名・カテゴリコードを対象に含め、カテゴリ指定での絞り込みを可能にする。
2. 既存の検索ロジックとUI/UXを破壊せず、パフォーマンスとメンテナンス性を担保した実装を行う。
3. 検索仕様をドキュメント化し、今後の検索対象拡張（タグ・属性など）に備えた設計を整える。

## 3. スコープ
- 対象画面: `lib/app/features/inventory/...` の在庫管理一覧、`lib/app/features/menu/...` のメニュー管理一覧。
- 対象機能: 検索入力フィールドのロジック、および関連するRiverpodプロバイダやサービス層の検索クエリ生成。
- 非対象: カテゴリマスタの編集機能、カテゴリラベルの翻訳、並び替え仕様の変更。

## 4. 現状整理
- データソース
  - 在庫: `InventoryItem`（カテゴリID参照）、`InventoryRepository` がSupabase view/tableからカテゴリ情報付きで取得。
  - メニュー: `MenuItem` または `Recipe` 系モデル（カテゴリID参照）。
- 検索ロジック
  - 多くの場合 `SearchFilter`（仮）や `state.filteredItems` 生成時に `String.contains` 等で名称比較。
  - カテゴリ名が検索対象に含まれていない、もしくはUI層でカテゴリラベルを保持していない可能性。

## 5. 対応方針
- **データレイヤー**: 取得済みカテゴリIDに対応するカテゴリ名/コードをDTO・Entityに含める。未取得の場合はSupabaseクエリを調整（JOINまたは別途マスタキャッシュ）。
- **リポジトリ/サービス層**: 検索用の正規化済み文字列（名称・かな・コード・カテゴリ）をまとめたヘルパを追加。カテゴリ名の複数表記（英語・日本語）に対応するためローマ字/かな変換ユーティリティが既存なら再利用。
- **UI/ViewModel層**: 検索入力に対してカテゴリ名を含む比較を実施。カテゴリラベルが未保持の場合はViewModel内でカテゴリ辞書を参照。
- **UX**: 入力補助は現状維持。カテゴリでヒットした場合も同一のハイライト/並び順とする。
- **テスト**: Riverpodのユニットテストでカテゴリ名ヒット・カテゴリ不一致を確認。Widgetテストでカテゴリ名検索時のフィルタ結果を検証。

## 6. 実装タスク
1. **仕様確認とドキュメント整備**
   - 現状の検索対象フィールドを調査し `docs/draft/inventory_table_ui_improvement_proposal.md` / `docs/draft/menu/...` を参照。
   - 新検索仕様を `docs/draft/search/search_spec.md` (新規) に追記（必要であれば）。
2. **データモデル更新**
   - `InventoryItem`, `InventoryDto` 等に `categoryName`, `categoryCode` を追加（既にある場合はnull対応確認）。
   - `MenuItem` 系モデルにも同様に追加。
   - `json_serializable` 更新後 `flutter pub run build_runner build --delete-conflicting-outputs` を予定（CIで自動実行される場合はローカル実行不要に調整）。
3. **Repository/Service修正**
   - SupabaseクエリにカテゴリテーブルのJOINを追加し、レスポンスにカテゴリ名称を含める。
   - 検索用ヘルパ `SearchIndexBuilder` (仮) にカテゴリ名称を追加。
   - 在庫・メニュー双方で共通化できる場合は `shared/search` にユーティリティを移動。
4. **ViewModel/UI調整**
   - 在庫一覧の検索フィルタ（例: `InventoryListController.filterItems`）にカテゴリ名称を追加。
   - メニュー一覧の検索フィルタ（例: `MenuListController`）も同様。
   - カテゴリ名取得が非同期の場合、初回ロード後に検索インデックスを更新する処理を追加。
5. **テスト追加**
   - 在庫検索ユニットテスト: カテゴリ名完全一致・部分一致を確認。
   - メニュー検索ユニットテスト: 英字カテゴリ・日本語カテゴリ双方でヒットすること。
   - Widgetテスト（任意）: 検索バー入力→リスト反映スナップショット。
6. **パフォーマンス/エラーハンドリング確認**
   - 大量カテゴリ時の検索速度をプロファイル。
   - カテゴリがnullの場合のフォールバック（検索対象から除外、エラーとしない）。
7. **ドキュメント更新・レビュー**
   - 本計画に基づく実装PR後、`docs/standards/search_guideline.md` が存在する場合は差分更新。
   - リリースノート（`docs/logging/release_notes.md` 等）に追記。

## 7. 影響範囲
- Flutterフロントエンド: 在庫・メニュー機能のViewModel、検索ロジック、テスト。
- Supabase: カテゴリテーブルとのJOIN追加（読み込み専用）。
- ドキュメント: 検索仕様、カテゴリ辞書の整合性記録。

## 8. リスクと対策
| リスク | 内容 | 対策 |
| --- | --- | --- |
| パフォーマンス低下 | 検索対象フィールドが増え、フィルタ処理が重くなる | 検索対象文字列を事前に正規化キャッシュし、リスト生成時の計算を削減 |
| カテゴリデータ欠落 | カテゴリマスタ未設定アイテムでNPE/例外が発生 | nullガード・デフォルトラベル設定、検索対象から除外 |
| クエリ拡張によるAPI破壊 | Supabaseクエリ変更で他画面に影響 | Repository経由で利用している他画面を洗い出し、スナップショットテストで検証 |
| テスト不足 | 検索仕様変更による回 regress | 回帰用ユニットテスト追加、重要ケースをGoldenテストでカバー |

## 9. 完了条件
- 在庫管理・メニュー管理の検索でカテゴリ名・カテゴリコード入力時に該当アイテムが表示される。
- カテゴリ情報が非設定のアイテムでも検索処理がエラーなく動作する。
- 追加ユニットテスト・Widgetテストが成功し、CIが通過する。
- 関連ドキュメントの更新が完了し、レビュアから承認を得る。

## 10. 次のアクション
1. 現行検索ロジックのコード調査 (`lib/app/features/inventory/...`, `lib/app/features/menu/...`) と影響範囲洗い出し。
2. カテゴリデータの取得状況を確認し、必要に応じてSupabaseクエリ修正案を作成。
3. 実装ブランチ作成 (`feature/inventory-menu-category-search`) とタスクリストをIssue化。