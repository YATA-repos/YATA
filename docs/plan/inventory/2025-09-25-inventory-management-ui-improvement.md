mi# 在庫管理UI 改善計画（計画書）

> 種別: plan / 状態: 計画中（未実装） / 対象: inventory
> 
> 作成日: 2025-09-25

---

## 概要

本ドキュメントは、在庫管理画面（Inventory Management）のUI/UXおよび操作効率の改善計画をまとめたものです。実装はまだ行わず、優先度と段階的ロードマップ、成功指標、受け入れ基準、リスク・前提を定義します。

参照: スクリーンショット `_images/mocks/inventory_management_page.png`

---

## 背景と現状観察

- 画面構成: KPIカード（アイテム数/ステータス）、検索・カテゴリフィルタ、在庫一覧テーブル、行ごとの調整（- 0 +）と「適用」ボタン。
- ステータス（十分/少/危険）のバッジとカテゴリチップはあるが、並び替えや一括適用は不明瞭。
- 単位（個/kg/L/玉）が混在し、在庫量と閾値（警/危）の表記が初見で把握しにくい。
- 行ごとに「適用」ボタンが並び、視線移動とクリック数が多くなりがち。

課題仮説:
- 複数行の同時調整で手数が多い（行単位の適用に限定）。
- ステッパーのみの調整は、キーボード主体のオペレーションに弱い。
- 差分や閾値との距離が直感的に把握しづらい。
- バリデーション（負在庫等）と未保存離脱の安全策が不十分の可能性。

---

## 改善方針（原則）

- 操作回数を最小化（キーボードファースト＋一括操作）。
- 情報密度は保ちつつ、優先情報の視覚強調（差分、状態）。
- 単位・丸めルールの一貫性。
- 安全性（バリデーション/離脱ガード/Undo）とパフォーマンス（仮想化/バッチ更新）の両立。

---

## 改善アイデア（優先度）

### P0: クイックウィン（即効性）
- ステータスカード（十分/少/危険）をクリックでフィルタ連動。アクティブ状態を視覚表示。
- テーブルの数値を右寄せ、単位は薄色で隣接。差分は「±n」を緑/赤で強調。
- 並び替え（状態、在庫量、差分、更新日時）をヘッダーに追加。
- 差分が0のとき「適用」を無効化＋ツールチップで理由表示。
- 未適用クリアを上部に固定し、未適用件数を表示。

### P1: 操作効率・一括操作
- 画面下部に一括適用バーを新設（未適用件数、合計差分、選択行に適用/全件適用/取り消し/下書き保存）。
- 行選択（チェックボックス）＋キーボードショートカット（↑↓行移動、←→ステップ、Enter行適用、Ctrl+Enter一括適用）。
- ステッパーに加えて直接入力フィールドを併設（単位別ステップ: 個1, kg0.1, L0.1 など）。

### P1: 安全性・バリデーション
- 新在庫<0は適用禁止＋エラーメッセージ。閾値割れは黄色の警告バナー（続行/キャンセル）。
- 未保存離脱ガード（beforeunload/ルートガード）。
- Undo/Redo（直近操作に対しスナックバーから取り消し）。

### P2: 情報設計の明確化
- 閾値表記を「警告閾値/危険閾値」にリライト。ヘルプアイコンで説明。
- KPIカードのドリルダウン（クリックでスクロール＋フィルタ）。
- 各行に「最後の更新者/時刻」を薄字で表示。履歴モーダルから過去変更を参照。

### P2: 単位・一貫性
- 品目マスタに unit/step/decimals/min/max を定義し、UIは準拠。
- 小数桁と丸め（四捨五入/切上げ/切下げ）の統一ルールを設定。
	- 実装規約は docs/standards/unit_normalization.md を参照。

### P3: パフォーマンス/アクセシビリティ
- 仮想スクロール or ページング、検索のデバウンス（200–300ms）。
- バッチ更新API＋楽観的UI更新とロールバック。
- キーボード操作網羅、ARIA/ライブリージョンによる読上げ、モバイルカード化。

---

## ロードマップ（例）

- 週1: P0 一式（フィルタ連動、並び替え、差分強調、無効化/ツールチップ、未適用クリアUI）。
- 週2–3: P1（下部一括適用バー、行選択、ショートカット、直入力、離脱ガード、基本バリデーション）。
- 週4–5: P2（閾値表記リライト、更新者/時刻、履歴モーダル、単位/丸めルール）。
- 週6+: P3（仮想スクロール、バッチAPI、楽観的更新、アクセシビリティ強化、モバイル最適化）。

---

## 成功指標（KPI）

- 1セッションで在庫調整完了までの中央値: P1後に30%短縮。
- 一括適用の利用率: 調整セッションの50%以上。
- 適用エラー（負在庫/閾値割れ）率: P1後に70%削減、P2後に85%削減。
- 未保存離脱の発生率: 60%削減。
- パフォーマンス: 1000行で初回表示<1.5s、操作ラグ<100ms（P3）。

---

## 受け入れ基準（抜粋）

- ステータスカードクリックでテーブルが即時フィルタされ、バッジにアクティブ状態が付く。
- ヘッダークリックで並び替え（昇順/降順/リセット）。在庫量・状態・更新日時で動作。
- 差分0の行は「適用」ボタンが押せず、ホバーで「変更がありません」と表示。
- 直接入力→Enterで行適用、Ctrl+Enterで一括適用が動作。
- 新在庫が0未満は適用不可。閾値割れは警告表示のうえ続行/キャンセル選択。
- 未適用変更がある状態で遷移/リロード時に確認ダイアログが表示される。
- 一括適用バーに未適用件数/合計差分が常時表示され、選択行のみ/全件の適用を切替可能。

---

## 技術メモ（実装前の前提）

- 状態管理: 未適用差分は `Map<ItemId, delta>` で保持し、未適用件数・合計差分をセレクタで集計。
- 競合処理: 行ごとに `version` を持ち、適用時にサーバーの世代と照合。競合時は最新取得→再適用を案内。
- 監査ログ: 適用時に `userId, timestamp, delta, reason?` を記録。
- API: バッチ更新エンドポイントの有無を確認（なければ設計追加）。

---

## リスク・前提・未確定

- リスク: 楽観的更新の失敗時整合性ズレ（ロールバックの設計必須）。
- 前提: バッチ更新APIの提供、負在庫許容ポリシー、在庫単位の最小刻み。
- 未確定: ステータス算出ロジックの閾値、拠点/ロット管理の範囲、履歴保持期間。

---

## 付録

- 参考画像: `../../_images/mocks/inventory_management_page.png`
- 関連標準: `../standards/architecture.md`, `../standards/documentation_guidelines.md`
