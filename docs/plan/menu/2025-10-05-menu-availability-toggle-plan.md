# 操作カラム販売状態トグル化計画（2025-10-05）

## 背景
- TODOタスク「Menu-Enhancement-7」はメニュー管理テーブルの操作カラムから複数ボタンが並ぶ状態を解消し、販売可否のみ即時操作できるスリムなUIへ改修する目的で登録されている。
- 現行の `MenuItemTable` では「詳細を表示」「編集」「販売可否トグル」「レシピ編集」の4ボタンを横並びで提供しており、視認性・アクセシビリティ・タップターゲット間隔の観点で負担が大きい。
- 依存タスク「Menu-Enhancement-5」で詳細表示をサイドパネルからモーダルへ移行する計画が進行中であり、その他操作（編集・レシピ・削除など）をモーダル側へ集約できる状況を整えることが前提となる。
- 以上を踏まえ、操作カラムでは販売状態のみを即時切り替え、その他操作は詳細モーダルに統合する設計へと移行する。

## スコープ
- 対象タスク: `Menu-Enhancement-7`
- 対象コード: `lib/features/menu/presentation/widgets/menu_item_table.dart`, `lib/features/menu/presentation/pages/menu_management_page.dart`, `lib/features/menu/presentation/widgets/menu_detail_panel.dart`
- 対象ステート: `MenuManagementController.toggleMenuAvailability`, `MenuManagementState`
- 対象UX: メニュー一覧テーブルの操作カラム、詳細モーダルのアクションレイアウト

## 現状整理
1. 操作カラムには `IconButton` が4種類存在し、横幅を圧迫している。
2. 行タップで詳細パネル（将来的にはモーダル）が開くため、「詳細」ボタンは導線が重複している。
3. `toggleMenuAvailability` は二値トグル（`bool isAvailable`）を想定しており、ラジオUIへ置換してもAPI側の仕様変更は不要。
4. 権限・バリデーションはサービス層で制御されるが、UI側でも非同期中は入力をロックしリトライ導線を提示する必要がある。
5. 詳細パネル（モーダル）には現在レシピ編集ボタンのみが配置されており、編集・削除などの主要操作を集約するスペースが十分にある。

## 目標（Success Criteria）
- テーブルの操作カラムが「販売中」「販売停止」を切り替えるラジオボタン群（もしくは同等の二値切替UI）のみで構成される。
- 各行のその他操作（メニュー編集、レシピ編集、削除、複製など既存機能）は詳細モーダルからアクセスできる。
- 販売状態変更操作は1クリックで反映し、処理中はラジオをロック＆スピナー表示、失敗時にはエラー通知と再試行手段を提供する。
- アクセシビリティ（スクリーンリーダー、キーボード操作）に対応したラジオ群のラベリングが実装される。
- 既存の `MenuManagementController` / `MenuManagementState` のインターフェースとテストが更新され、回帰なく動作する。

## 非スコープ
- 在庫可用性ロジック、リアルタイム購読、自動更新アルゴリズムの変更。
- 詳細モーダル自体のデザイン刷新（モジュール化・リサイズ等）は依存タスク内で対応する。
- モバイル専用の大幅なレイアウト変更。必要最小限のレスポンシブ調整のみ本計画で扱う。

## 前提・依存
- `Menu-Enhancement-5` が完了し、詳細がモーダル表示に統一されていることを前提とする。未完了の場合は本タスク内で暫定的にパネル／モーダル双方へアクションを重複配置する暫定策を入れる。
- `MenuManagementController.toggleMenuAvailability` のAPIが成功時にメニュー一覧へ反映される既存挙動をそのまま利用する。
- 詳細モーダル内で編集／削除が機能するよう、必要に応じて `MenuDetailPanel` にアクションスロットを追加する。

## UX/インタラクション設計
### 操作カラム
- 列見出しを「販売状態」に変更し、2択のラジオボタングループを配置。
- 選択肢ラベルは「販売中」「販売停止」。カラーリングは `YataStatusBadge` と整合するよう `YataColorTokens.primary` / `YataColorTokens.textSecondary` を利用。
- ラジオ選択後に非同期処理が完了するまで `CircularProgressIndicator` またはフェードアウトされた無効ラジオを表示。
- エラー発生時はスナックバーもしくはテーブル上バナーで通知し、選択状態を旧値へロールバック。

### 詳細モーダル
- タイトル付近に「編集」「レシピ編集」「複製（存在する場合）」「削除」などの主要操作ボタンを`ButtonBar`またはボタン群で集約。
- 販売状態はモーダルでも現在値を参照できるよう表示のみ維持し、変更操作はテーブル側のみが即時導線となる。
- モーダルでの操作完了後はテーブルへ反映されるよう、既存の `_controller.refreshAll()` または局所更新ロジックを再利用。

### アクセシビリティ
- ラジオボタンには `Semantics(label: "販売状態", value: ... , hint: ... )` を付与。
- キーボード操作時に `FocusTraversalGroup` を用意し、上下矢印で選択できるよう `RadioListTile` / カスタム `ToggleButtons` のいずれかを選択。

## データフローとロジック
- UI → Controller: ラジオ選択時に `toggleMenuAvailability(menuId, isAvailable)` を呼び出す。
- Controller → Service: 既存実装通り `MenuService.toggleMenuItemAvailability` を実行。成功時に `state.menuItems` を更新。
- 楽観的更新: UIで即時切り替え後、失敗時に `state.errorMessage` へ設定し元の状態へ戻す。`MenuManagementState` に `Map<String, bool> pendingAvailability` のような補助状態を追加して管理することを検討。
- 非同期中は対象行のみ `isBusy` フラグを立て、隣接行には影響しないよう分離する。

## 実装ステップ
1. **詳細モーダルのアクション設計**
   - `MenuDetailPanel` に汎用アクションスロットを追加し、既存の編集・レシピ編集ボタンをここへ再配置。
   - 追加で必要な操作（削除、複製等）がある場合は `MenuManagementPage` からコールバックを受け取れる構造にする。
2. **テーブルUI刷新**
   - `MenuItemTable` から各種 `IconButton` を削除し、最終列をラジオボタングループへ差し替え。
   - ビジー状態・エラー復旧のためのステート（例: `busyMenuIds`）を受け取れるようプロパティを拡張。
3. **ステート＆コントローラー更新**
   - `MenuManagementState` に行単位の非同期状態とエラーメッセージを追加。
   - `toggleMenuAvailability` を行単位でビジーフラグを立てるよう更新し、失敗時のロールバック処理を追加。
   - 既存テストを更新し、成功／失敗パスの状態遷移を検証。
4. **詳細モーダルへの操作移管**
   - `MenuManagementPage` からモーダル起動時に編集・レシピ等のコールバックを渡し、操作完了後にテーブルと同期。
   - 必要に応じて `MenuDetailPanel` で `Navigator.pop` 後に `refreshAll` を呼び出すフックを提供。
5. **UI微調整とレスポンシブ確認**
   - テーブル列幅・ラジオサイズ・余白を調整し、PC／タブレットでセル高さが既存設計に収まることを確認。
   - モバイル（横スクロール時）の操作性を確認し、ラジオの最小タップ領域44pxを確保。
6. **テスト＆ドキュメント更新**
   - `flutter analyze` / `flutter test`（メニュー関連のユニット＆ウィジェットテスト）を実行。
   - 手動テストケース（下記参照）を消化し、結果をTODOやリリースノートへ反映。

## テスト戦略
- **ユニットテスト**
  - `MenuManagementController.toggleMenuAvailability` の成功ケースで `pendingAvailability` が解除されること。
  - 失敗ケースで `state.errorMessage` に値が入り UIがロールバックすること。
- **ウィジェットテスト**
  - `MenuItemTable` のラジオ選択操作がコールバックを呼び出すこと。
  - ビジーフラグが立っているときにラジオが無効化されること。
- **手動テスト**
  - 連続トグル操作（販売中→停止→販売中）が正常に反映される。
  - エラー発生時（ネットワーク遮断など）にラジオが元に戻り、エラーバナーが表示される。
  - 詳細モーダルから編集／レシピ編集が実行でき、完了後にテーブルへ反映される。

## リスクと緩和策
| リスク | 影響 | 緩和策 |
| --- | --- | --- |
| 行タップとラジオ操作が競合して詳細モーダルが誤開封 | UX低下 | ラジオ領域内で`InkWell`を個別ハンドリングし、`onRowTap`とバッティングしないよう `DataCell` の `onTap` を無効化。 |
| 非同期滞留でラジオが無効化されたまま復帰しない | 販売状態変更不可 | `finally` ブロックで常にビジーフラグ解除、`Completer`未解決時のタイムアウトを設定。 |
| 依存タスク未完了で操作導線が欠損 | 機能停止 | 計画段階で `Menu-Enhancement-5` の進捗を確認し、未完の場合はサイドパネルにも暫定的なボタンを残す。 |
| モーダル操作が多くなり操作手数が増加 | 運用負荷 | モーダル上部に主要操作をまとめ、ショートカットキー・フォーカス遷移を検討。 |

## フォローアップ候補
- バルクトグル機能（複数行選択→一括販売停止）を検討し、テーブルヘッダへチェックボックスを追加。
- 詳細モーダル内での販売状態表示をバッジ化し、テーブルと一貫したカラーコードを採用。
- 操作ログ（販売状態変更履歴）の表示機能を将来的に追加して監査可能性を強化。

## 実装ステータス（2025-10-04）
- `MenuItemTable` の操作カラムはトグル専用のラジオスタイルUIへ置き換え済み。`ToggleButtons`＋スピナーで行単位の処理状態を表示する。
- `MenuManagementState` に `pendingAvailabilityMenuIds` / `availabilityErrorMessages` を追加し、`MenuManagementController.toggleMenuAvailability` で楽観的更新＋ロールバックを実装した。
- 詳細モーダル (`MenuDetailPanel`) に編集・レシピ編集・削除ボタンを集約し、テーブル側のボタンは撤去。
- ウィジェット／ユニットテストとして `menu_management_controller_test.dart` を追加し、販売状態更新の成功／失敗遷移を検証。
