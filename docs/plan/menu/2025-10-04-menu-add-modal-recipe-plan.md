# メニュー追加モーダル レシピ追加機能修正計画（2025-10-04）

## 目的
- メニュー管理画面の「メニュー追加」モーダルから、レシピ（材料と必要量）を同時登録できるようにし、メニュー作成直後から在庫連動が働く状態を実現する。
- メニュー作成フローを分断せず、運用担当者が同じダイアログ内でメニュー情報とレシピを完結に設定できる UX を提供する。
- 既存のメニュー編集・レシピ編集フローとの整合性を保ちながら、コードベースの複雑度を抑えて拡張する。

## 背景
- 現状の `_showMenuFormDialog`（`menu_management_page.dart`）では、`MenuFormData` にレシピ情報を保持するフィールドが存在せず、保存後に別ダイアログでレシピを編集する必要がある。
- `MenuService.createMenuItem` はメニュー本体のみを登録し、初期レシピをセットする手段が提供されていないため、レシピ登録は二度手間になり在庫可用性が未連動のまま残りやすい。
- `2025-10-02-menu-recipe-dependency-remediation-plan.md` でレシピ CRUD の整備方針は定められているが、メニュー作成体験の改善はカバーできていない。
- 運用現場から「メニュー追加時にレシピまで入力したい」「保存直後に在庫可用性が未設定になるのを避けたい」という要求が上がっている。

## スコープ
- メニュー追加モーダルの UI/UX 改修と、それを支えるコントローラ／サービスの拡張。
- メニュー編集モーダルへの影響範囲を最小化しつつ、必要な共通コンポーネントの切り出し。
- 追加となるドメイン／DTO 定義、テスト、ドキュメント更新。
- データ移行や既存レシピの再登録は含めない（別計画を参照）。

## 成果物
- 初期レシピを含むメニュー作成 API 呼び出しフロー（`MenuService`／`MenuManagementController`）。
- レシピ入力を備えたメニュー追加モーダル（ステップ形式またはタブ形式）。
- UI ロジック／サービス層のユニットテスト・ウィジェットテスト群。
- 更新された開発者向けドキュメント（plan/intent/guide の必要箇所）。

## 課題整理
| 課題 | 詳細 | 根本原因 |
| --- | --- | --- |
| レシピを同時登録できない | モーダルに材料入力欄がなく、作成後に別フローで登録する必要がある | フォームデータ構造にレシピ情報が存在しない／UI 未実装 |
| メニュー作成直後の在庫可用性が未判定 | レシピ登録前の状態で `MenuService.createMenuItem` が完了するため | サービス層がレシピ登録と在庫再計算をトランザクション的に扱っていない |
| UX の一貫性不足 | 編集フローと追加フローで操作感が乖離し、混乱を招いている | コンポーネント分離が不十分で、レシピ編集 UI が再利用できていない |
| テスト不備 | モーダルがレシピ入力を想定していないためテストケースが欠如 | テスト設計がメニュー情報のみにフォーカスされている |

## 要件

### 機能要件
1. メニュー追加モーダルで材料検索・必要量入力・任意フラグ設定・備考入力ができる。
2. レシピ行の追加／編集／削除がメニュー作成前に完結し、重複材料バリデーションが走る。
3. 保存操作でメニュー本体とレシピがまとめて登録され、登録後に在庫可用性が再計算される。
4. 保存失敗時はエラーメッセージをモーダル内に表示し、入力値を保持したまま再試行できる。
5. 初期状態でレシピ登録をスキップすることも可能（最低要件は従来通り）。

### 非機能要件
- 既存のメニュー編集・レシピ編集（別ダイアログ）が壊れないこと。
- UI 操作は 500ms 以内にフィードバック（スピナー／トースト）を返す。
- 主要フローに対するテストを追加し、CI 上でグリーンになること。
- 操作説明を `docs/guide/menu/` 系ドキュメントに追記する準備を行う（別タスクで反映）。

## 解決アプローチ

### フェーズ1: サービス／リポジトリ整備
- `MenuService.createMenuItem` に `List<MenuRecipeFormData>`（仮）を受け取るオーバーロード／引数を追加し、Supabase 側でメニュー作成とレシピ一括登録をトランザクション化する。
- `RecipeRepository` に複数レコードの一括 upsert API を追加、重複材料チェックをリポジトリ層でも実施。
- 追加登録後に `bulkCheckMenuAvailability` を対象メニューに対して再計算し、`MenuAvailabilityInfo` を返すヘルパーを整える。

### フェーズ2: 状態管理拡張
- `MenuFormData` にレシピドラフト（`List<MenuRecipeDraft>`）を保持するフィールドとメソッドを追加。
- `MenuManagementState` に作成中レシピリスト、材料候補キャッシュ、モーダル内のバリデーション状態を追加。
- `MenuManagementController` に以下を実装：
  - 新規メニュー作成時のレシピドラフト操作（追加・更新・削除）のステート管理。
  - 保存時に `createMenuItem` とレシピ登録をまとめて呼び出し、処理結果を UI に反映。
  - エラー時にモーダルへ状態を返すための `MenuCreationError` DTO。

### フェーズ3: UI/UX 改修
- `_showMenuFormDialog` をステップ構成化（例：Step1 基本情報、Step2 レシピ）またはセクション内タブ化し、レシピリストコンポーネントを埋め込む。
- 既存の `_RecipeEditorDialog` から材料検索・バリデーション UI を切り出して再利用できる `MenuRecipeEditor` ウィジェットを新設。
- レシピリストには以下を表示：材料名、必要量＋単位、任意フラグ、備考、削除ボタン。
- レシピが 0 件の場合は警告表示を出しつつ保存は許可（後続でチェックリスト提示）。

### フェーズ4: 可用性・統合調整
- 作成完了後に `MenuManagementController` で該当カテゴリ一覧と可用性を再フェッチし、テーブルへ即時反映。
- snackbar や dialog を用いて「レシピを登録しました／在庫を更新しました」を通知。
- 既存の詳細モーダル・レシピ編集フローにも新コンポーネントを反映し、UX を統一。

### フェーズ5: QA とドキュメント
- ユニットテスト：`MenuManagementController.createMenu`（正常／重複材料／API エラー）。
- ウィジェットテスト：メニュー追加モーダルのステップ遷移、レシピ追加／削除、保存成功・失敗時の表示。
- モックサービスを用いた統合テストで在庫可用性再計算まで確認。
- `docs/plan/` 本ドキュメントをベースに intent/guide の更新チケットを起票。

## 実装上の注意点
- Supabase RPC またはトランザクションのサポート状況を確認し、必要なら一時的に順次 API 呼び出し＋ロールバック処理で代替する。
- 材料候補取得は既存の `getMaterialCandidates` を流用し、検索頻度を抑えるためにモーダル内でキャッシュする。
- フォームバリデーションは `DecimalTextInputFormatter` 等既存のユーティリティを活用し、小数対応を保証する。
- i18n 文言キーを `shared/l10n` に追加する場合は別 PR に切り出す。

## テスト計画
- **ユニットテスト**: `MenuService.createMenuItemWithRecipes`、`MenuManagementController._submitMenuDraft`。
- **ウィジェットテスト**: モーダル UI の主要操作パス（追加→編集→削除、エラー表示）。
- **ゴールデンテスト**: レシピ入力セクションのレイアウト確認（必要に応じて）。
- **統合テスト**: フェイクリポジトリでメニュー作成→レシピ登録→可用性更新を検証。

## ロールアウト計画
1. `feature/menu-add-modal-recipes` ブランチで実装を進め、フェーズごとに小さめの PR を提出。
2. Staging 環境で実際にメニュー追加 → レシピ登録 → 在庫反映を手動確認。
3. 運用メンバー向けに新フローの簡易ガイド（スクリーンショット付き）を共有。
4. 本番デプロイ後、24 時間は在庫自動更新ログとレシピ登録エラーをモニタリング。

## リスクと対策
| リスク | 影響 | 対策 |
| --- | --- | --- |
| メニュー作成とレシピ登録の間でエラーが発生し、一方のみ成功 | データ不整合（レシピなしのメニューが残る） | トランザクション化／失敗時に作成済みメニューをロールバック、UI にリトライ導線を提示 |
| モーダル複雑化による UX 低下 | 利用者が操作に戸惑う | ステップヘッダとコンテキストヘルプを追加、初期状態のガイダンス文を表示 |
| 材料候補の検索負荷増加 | Supabase API の負荷増 | 入力補助にデバウンスを導入し、状態側でキャッシュ |
| 既存レシピ編集ダイアログとの重複コード | メンテコスト増 | 共通ウィジェット・ビルダーを作成し、両フローで再利用 |
| テスト追加による CI 時間増 | ビルド時間の延伸 | テストをモジュール単位で最適化し、重複シナリオを削減 |

## 関連資料
- `docs/plan/2025-10-02-menu-recipe-dependency-remediation-plan.md`
- `docs/plan/2025-10-03-menu-management-page-implementation-plan.md`
- `lib/features/menu/presentation/pages/menu_management_page.dart`
- `lib/features/menu/presentation/controllers/menu_management_controller.dart`
- `lib/features/menu/services/menu_service.dart`
