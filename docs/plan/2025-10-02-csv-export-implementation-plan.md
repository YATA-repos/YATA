# CSVエクスポート実装計画 (2025-10-02)

## 1. 背景
- 小規模飲食事業者向け在庫・注文管理システム「YATA」において、会計処理、メニュー改善、在庫最適化など業務上の重要指標を外部共有する手段が不足している。
- `docs/draft/csv_export_design_draft.md` で整理した11種の明細系CSVと4種の事前集計CSVを実装することで、現場が税理士・仕入先・店舗スタッフとデータ連携しやすくなる。
- V1では会計・棚卸・メニュー改善に必須な5本を最優先し、段階的に拡張する。

## 2. 目的
1. 事業運営で即利用できるCSVエクスポート機能を提供し、マニュアル業務を削減する。
2. 既存データモデル（注文、仕入、在庫、レシピ）を安全に再利用し、SupabaseとFlutterアプリ双方で保守しやすい設計を整える。
3. データ品質・再現性を担保するため、計算式・キー・タイムゾーンなどの仕様を統一しドキュメント化する。

## 3. スコープ
### 3.1 プロダクト機能
- 管理者アプリからのオンデマンドCSVエクスポート
- バックエンドによるデータ抽出・整形ロジック
- 将来的なスケジュール実行（自動メール等）の布石としてのジョブ基盤準備（V1では手動実行のみ）

### 3.2 技術レイヤー
- **Flutter**: エクスポート操作UI、ダウンロード処理、進捗表示
- **Business Service**: エクスポートユースケース（集計、検証）
- **Repository/Supabase**: SQL View / RPC / Function の整備、パラメータ化されたクエリ
- **ストレージ**: Supabase Storageまたはローカルダウンロード（V1は端末保存を前提）

## 4. リリースフェーズ
| フェーズ | 期間目安 | 対象CSV | 主な成果物 |
| --- | --- | --- | --- |
| Phase 0 | 2025-10-02 〜 2025-10-06 | ― | データ辞書整備、サンプル出力検証環境、共通コンポーネント設計 |
| Phase 1 (V1) | 2025-10-07 〜 2025-11-01 | 売上明細/仕入明細/在庫トランザクション/廃棄ログ/メニュー工学日次集計 | 実運用開始、会計対応完了 |
| Phase 2 | 2025-11-02 〜 2025-11-22 | レシピ原価/棚卸スナップショット/仕入価格履歴/日次売上サマリ | 原価改善支援 |
| Phase 3 | 2025-11-23 〜 2025-12-15 | 発注点推定/欠品ログ/提供リードタイム/時帯・カテゴリ集計/在庫回転 | オペ・需要予測強化 |

## 5. 共通設計ポリシー
- **ファイル形式**: UTF-8 (BOM付) / RFC4180準拠 / ヘッダ行あり
- **キー項目**: org_id, location_id, business_date, order_id, line_id, sku_id 等を固定列として含める
- **タイムゾーン**: すべて `Asia/Tokyo` のISO8601 (`YYYY-MM-DDTHH:MM:SS+09:00`)
- **金額**: 税抜/税込いずれかをファイル内で統一し、メタ情報をヘッダコメントに記載
- **アクセス制御**: ロール `store_manager` 以上に限定。Supabase Row Level Securityポリシーを追加
- **API設計**: `ExportService` 経由で `ExportJob` を生成し、完了時にダウンロードURLまたは端末保存

## 6. アーキテクチャと実装タスク
### 6.1 データアクセス (Supabase / Repository)
1. **共通ビュー / マテリアライズドビュー**
   - `sales_line_items_view`, `purchases_line_items_view`, `inventory_movements_view`, `waste_log_view`, `menu_sales_daily_view` を作成
   - 将来的な集計性能を考慮し、必要に応じてマテリアライズドビュー + リフレッシュジョブを検討
2. **RPC (stored procedure)**
   - `fn_export_csv(dataset_id, params jsonb)` を定義し、指定期間・店舗を引数にCSV文字列を返却
   - 期間指定のバリデーション、最大レコード数制限、タイムアウト監視
3. **リポジトリ層**
   - `CsvExportRepository` を新設し、RPC呼び出しとレスポンスストリーム取得を実装
   - 大規模データ対応のため、Supabase Functionsの`COPY`/`SELECT ... CSV`活用も検討

### 6.2 ビジネスサービス層
- `CsvExportService`
  - 入力: Dataset種別, 期間(from/to), Location, 出力先設定
  - バリデーション: フィルタ必須、期間上限（例: 31日）
  - 出力: `ExportResult(fileName, bytes/stream)`
  - ログ: Export履歴を `export_jobs` テーブルに記録（開始・完了・失敗、エラー内容）
- 再利用: メニュー工学や在庫分析の既存集計サービスがある場合はコール

### 6.3 Flutter UI/UX
1. **画面設計**
   - `Settings > Data Export` もしくは `Analytics` モジュール内にエクスポート画面を設置
   - フィルター: 店舗選択、期間、CSV種別（複数選択可はPhase2以降）
   - 実行ボタン押下後はプログレス表示（`Export in progress`）と完了トースト表示
2. **UX**
   - 大量データの場合の注意文、推奨期間などを明記
   - オフライン時はキューに溜め、オンライン復帰時処理（Phase3以降）
3. **ダウンロード**
   - Android: `path_provider` + `share_plus` などで端末保存/共有
   - Windows: ファイル保存ダイアログ
4. **テレメトリ**
   - `analyticsLogger` にエクスポートイベントを記録（種別・期間・所要時間）

### 6.4 インフラ / 運用
- Supabase Edge Functionでの長時間処理対応（CSV生成が30秒超の場合）
- 将来的な自動配信（メール/Slack）はPhase3以降に `cron` 連携
- バックアップ: 出力CSVは端末保存前提だが、必要に応じてSupabase Storageへ一時保管 (24時間TTL)

## 7. フェーズ別詳細タスク
### Phase 0: 基盤準備
- データ辞書作成 (`docs/reference/dataset_dictionary.md` 新規)
- 既存スキーマのギャップ分析（カラム不足・正規化不足を棚卸）
- モックデータ生成＆手動SQL出力で草案CSVを検証
- ExportServiceのAPI仕様書作成

### Phase 1: 最小セットV1
1. **売上明細CSV**
   - Supabaseビュー & RPC
   - `CsvExportService` 実装
   - Flutter UIで期間指定ダウンロード
   - 単体/統合テスト
2. **仕入明細CSV**
   - 仕入（PO/GRN）との結合確認
   - テーブル間のJOIN性能確認
3. **在庫トランザクションCSV**
   - `stock_moves`・`prep_logs` 等ソース統一
   - 調整/廃棄など`tx_type`分類のENUM定義
4. **廃棄ログCSV**
   - ロス理由コードのマスタ整備
   - 記録漏れチェック機能
5. **メニュー工学用日次集計CSV**
   - 原価計算: 最新仕入価格 / 歩留まり補正 (draft参照)
   - 集計ロジックを`analytics`サービスに共通化

### Phase 2: 原価最適化セット
- レシピ原価スナップショット: レシピと仕入価格の履歴テーブル整備
- 実地棚卸結果: 棚卸入力機能と整合性確認
- 仕入価格履歴: 価格改定時の変更ログテーブル拡張
- 日次売上サマリ: 既存ダッシュボード集計を再利用

### Phase 3: オペレーション強化
- 発注点推定: 需要予測テーブル or ビュー整備
- 欠品・警告ログ: 通知履歴と連携
- 提供リードタイム: キッチンタイムスタンプの取得ルール固め
- 時帯/カテゴリ/在庫回転サマリ: 既存分析をCSV化

## 8. 品質保証
- **テスト層**
  - Repository: Supabase Mock / Integration Test
  - Service: 期間・フィルタ・データ件数の異常系テスト
  - Flutter: Widget Test + Golden Test（UI状態）
- **検証手順**
  1. 開発環境でダミーデータを用い、想定CSVと比較
  2. 税理士/店舗マネージャーにサンプル共有、フィードバック反映
  3. 本番リリース前にパイロット店舗で1週間運用

## 9. リスクと対策
| リスク | 詳細 | 対策 |
| --- | --- | --- |
| データ欠損・整合性 | 在庫調整や廃棄ログの入力漏れ | 入力UIで必須化し、エクスポート時に警告一覧を同梱 |
| パフォーマンス低下 | 大量データ集計によりSupabase負荷増大 | Viewのインデックス設計、バッチ期間制限、マテビュー採用 |
| セキュリティ | CSVに個人情報が混入 | カラム選定時にPII除外、ハッシュ化ルール徹底 |
| UX課題 | エクスポート完了が分かりづらい | トースト/通知、進捗表示、失敗時の再試行オプション |
| 仕様逸脱 | 将来の税制・店舗要件変化 | スキーマ変更に備え、ExportServiceを設定駆動に | 

## 10. 完了条件
- Phase 1の5本のCSVがUI経由でエクスポート可能、出力がドキュメント仕様と一致
- Export履歴が管理画面から確認でき、成功/失敗ログが保存されている
- 主要テスト（ユニット/統合/UI）がすべて成功
- `docs/draft/csv_export_design_draft.md` の仕様差分が反映されたドキュメント更新が完了
- パイロット店舗からの検証OK (ヒアリングメモを docs/intent または docs/logging に追記)

## 11. 次のアクション
1. Phase 0のデータ辞書作成と現行スキーマ棚卸 (オーナー: Data担当)
2. ExportService API設計レビュー (オーナー: Backendリード)
3. Flutter UIモック作成 & デザインレビュー (オーナー: モバイル担当)
4. Supabase RPCプロトタイプで売上明細CSVを試作 (オーナー: Backendリード)
5. セキュリティ・権限レビューをSecurity WGに依頼

---

*本計画はプロトタイプ段階のため、フェーズ進行に合わせて更新予定。フィードバックは `docs/plan/2025-10-02-csv-export-implementation-plan.md` のPRコメントか #yata-data-export チャンネルへ。*