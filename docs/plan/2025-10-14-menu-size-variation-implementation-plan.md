# メニューサイズバリエーション実装計画 (2025-10-14)

## 1. 背景と目的

### 1.1 背景
YATAの小規模飲食店向け管理システムにおいて、商品のサイズバリエーション（S、M、Lなど）に対する需要が高まっている。現在のシステムでは単一価格の商品のみ対応しており、サイズ別価格設定や注文時のサイズ選択ができない状況である。

### 1.2 目的
- ユーザーが商品に対してサイズオプション（S、M、Lなど）を追加・選択できる機能を実装
- サイズごとに異なる価格設定を可能にする
- 既存の注文・在庫・分析システムと整合性を保つ
- 段階的な移行により既存データの整合性を維持

## 2. 現状分析

### 2.1 既存システムの構造
- **MenuItem**: 基本的な商品情報を管理（名前、カテゴリ、価格、説明など）
- **MenuItemOption**: オプション管理システム（既存）
  - `optionName`: オプション名
  - `optionValues`: 選択可能な値のリスト
  - `isRequired`: 必須フラグ
  - `additionalPrice`: 追加価格
- **OrderItem**: 注文アイテム管理
  - `selectedOptions`: Map<String, String> でオプション選択を保存
  - `unitPrice`: 注文時点の単価

### 2.2 既存オプションシステムとの関係
既存の `MenuItemOption` は追加価格方式（ベース価格 + 追加料金）であるが、サイズバリエーションでは完全に異なる価格体系（S: 500円、M: 700円、L: 900円）が必要となる。

## 3. 実装方針

### 3.1 基本アプローチ
既存の `MenuItemOption` システムを拡張し、サイズバリエーションを特別なオプションタイプとして実装する。

### 3.2 データモデル拡張

#### 3.2.1 MenuItemOption の拡張
```dart
@JsonSerializable(fieldRename: FieldRename.snake)
class MenuItemOption extends BaseModel {
  // ... 既存フィールド
  
  /// オプションタイプ（ADDITIVE: 追加料金型, SIZE_VARIANT: サイズバリエーション型）
  OptionType optionType;
  
  /// サイズバリエーション用の価格マップ（optionType が SIZE_VARIANT の場合のみ使用）
  /// 例: {"S": 500, "M": 700, "L": 900}
  Map<String, int>? sizeVariantPrices;
}

enum OptionType {
  ADDITIVE,     // 従来の追加料金型
  SIZE_VARIANT, // サイズバリエーション型
}
```

#### 3.2.2 MenuItem の拡張
```dart
@JsonSerializable(fieldRename: FieldRename.snake)
class MenuItem extends BaseModel {
  // ... 既存フィールド
  
  /// サイズバリエーションの有無
  bool get hasSizeVariants {
    // MenuItemOption から SIZE_VARIANT タイプのオプションが存在するかチェック
  }
  
  /// デフォルトサイズの価格（サイズバリエーションがない場合の既存価格）
  int get defaultPrice => price;
  
  /// 指定サイズの価格を取得
  int getPriceForSize(String size) {
    // サイズバリエーションオプションから価格を取得
    // サイズバリエーションがない場合はdefaultPriceを返す
  }
}
```

### 3.3 UI/UX 設計

#### 3.3.1 メニュー管理画面
- サイズバリエーション設定用の専用UI追加
- 「サイズバリエーションを追加」ボタン
- サイズ名・価格のペア入力フィールド
- デフォルトサイズの概念（既存の単一価格商品との互換性）

#### 3.3.2 注文画面
- サイズバリエーションがある商品：サイズ選択UI表示
- サイズバリエーションがない商品：従来通りの表示
- 選択サイズに応じた価格の動的更新

#### 3.3.3 分析・レポート画面
- サイズ別売上分析の追加
- CSVエクスポート時のサイズ情報含有
- 在庫管理では商品単位（サイズ共通）で管理

## 4. 実装ステップ

### Phase 1: データモデル拡張 (1週間)
1. **OptionType enum の追加**
   - `lib/features/menu/models/option_type.dart` 作成
   
2. **MenuItemOption クラス拡張**
   - `optionType`, `sizeVariantPrices` フィールド追加
   - マイグレーション対応（既存データは ADDITIVE として処理）
   
3. **MenuItem ヘルパーメソッド追加**
   - `hasSizeVariants`, `getPriceForSize` メソッド実装

### Phase 2: サービス層実装 (1週間)
1. **MenuService 拡張**
   - サイズバリエーション作成・更新・削除API
   - 価格計算ロジックの実装
   
2. **OrderCalculationService 拡張**
   - サイズ選択時の価格計算ロジック
   - `OrderItem` 作成時のサイズ情報保存

### Phase 3: UI実装 (2週間)
1. **メニュー管理UI**
   - サイズバリエーション設定画面
   - 既存メニューテーブルへのサイズ表示統合
   
2. **注文管理UI**
   - サイズ選択コンポーネント
   - 価格表示の動的更新
   - カート表示でのサイズ情報表示

### Phase 4: 分析・レポート機能拡張 (1週間)
1. **売上分析**
   - サイズ別分析画面の追加
   - 既存分析画面のサイズ情報対応
   
2. **CSVエクスポート**
   - エクスポートデータにサイズ情報追加
   - サイズ別集計オプション

### Phase 5: テスト・最適化 (1週間)
1. **ユニットテスト**
   - 価格計算ロジックのテスト
   - サイズバリエーション操作のテスト
   
2. **統合テスト**
   - 注文フローの端から端までのテスト
   - データ整合性テスト

## 5. データ移行戦略

### 5.1 既存データ互換性
- 既存の `MenuItem` は自動的にデフォルトサイズ（"Default"）として扱う
- 既存の `MenuItemOption` は `optionType: ADDITIVE` として処理
- 既存の注文履歴はそのまま保持

### 5.2 段階的移行
1. 新機能をオプトイン形式で提供
2. 既存商品は従来通り動作
3. 店舗側でサイズバリエーション追加時のみ新機能有効化

## 6. 技術的考慮事項

### 6.1 パフォーマンス
- サイズバリエーション情報のキャッシュ戦略
- 注文画面での価格計算の最適化

### 6.2 データ整合性
- サイズバリエーション削除時の既存注文への影響回避
- 価格変更時の履歴保持

### 6.3 拡張性
- 将来的な他のバリエーション（トッピング、温度など）への対応
- 複数バリエーションの組み合わせ対応

## 7. リスクと対策

### 7.1 主要リスク
1. **既存データの破損**
   - 対策: 段階的移行とバックアップ戦略
   
2. **UI/UX の複雑化**
   - 対策: シンプルなデフォルト動作と段階的な機能公開
   
3. **パフォーマンス低下**
   - 対策: 事前のパフォーマンステストと最適化

### 7.2 回避策
- 機能フラグによる段階的リリース
- A/Bテストによるユーザビリティ検証
- 詳細なモニタリングとログ収集

## 8. 成功指標

### 8.1 技術指標
- 既存機能の動作保証（100%の後方互換性）
- 新機能のレスポンス時間（< 200ms）
- データ整合性の維持

### 8.2 ユーザー指標
- サイズバリエーション機能の採用率
- 注文フローの完了率
- ユーザーフィードバック評価

## 9. 今後の拡張計画

### 9.1 短期（3ヶ月）
- サイズ以外のバリエーション（温度、辛さレベルなど）対応
- バリエーション間の在庫連携

### 9.2 長期（6ヶ月〜）
- AI による推奨サイズ機能
- 動的価格設定（時間帯別、在庫状況別）
- 顧客別のお気に入りサイズ記録

## 10. 関連ドキュメント
- `docs/standards/architecture.md` - システムアーキテクチャ
- `docs/draft/add_size_to_menu.md` - 初期要件ドラフト
- `docs/plan/2025-10-12-menu-inventory-table-item-unification-plan.md` - テーブル共通化計画