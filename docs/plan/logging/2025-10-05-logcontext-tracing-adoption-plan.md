# LogContext / トレーシング活用計画 (2025-10-05)

## 背景
- `LogContext` による Zone ベースの文脈付与機能が実装済みだが、現状利用実績がない。
- リアルタイム処理やバッチ処理で関連ログを紐付ける需要が高まっている。
- UI トレーサ（`order_management_tracing.dart`）との連携により、ユーザー操作からバックエンド処理まで一気通貫のトレーシングを実現したい。

## 目的
- 代表的なサービスで `LogContext.runWithContext` を導入し、同一フロー内のログを `contextId` 等で関連付けられるようにする。
- トレーシングユーティリティを整備し、開発/運用の双方で利用可能なテンプレートを提供する。

## ゴール
- 少なくとも 2 つのロングランニング処理（例: リアルタイム購買同期、夜間バッチ）で LogContext が導入されている。
- `order_management_tracing.dart` と LogContext が連携し、UI 操作からサービス処理まで共通 ID が付与されている。
- ガイドラインにトレーシングのベストプラクティスが追記されている。

## スコープ外
- APM ツール（Datadog, New Relic 等）との連携。
- TimelineTask ベースのパフォーマンス計測改善（別計画で扱う）。

## 対応方針
1. **ユースケース選定**
   - リクエストが複数非同期処理にまたがる箇所（注文同期、在庫リフレッシュ）を対象に LogContext 導入を検討。
   - UI トレーサと組み合わせるフローを選定し、共通 ID 命名規則を定義。
2. **ユーティリティ整備**
   - `LogContext` にキー追加（`flowId`, `requestId`, `userId` 等）を容易にするヘルパーを提供。
   - Riverpod 用のトレーシングラッパ（`traceAsync` 仮称）を用意し、UI から簡単に呼び出せるようにする。
3. **導入と検証**
   - 対象サービスで `runWithContext` を使い、関連ログに `context` 情報が付与されることを確認。
   - UI トレーサから受け取った ID を Service 層に伝播させる仕組みを実装。

## 作業手順
1. LogContext の既存 API をレビューし、拡張が必要な箇所を洗い出す。
2. トレーシング ID の命名規則とライフサイクルをドキュメント化。
3. ヘルパーユーティリティを `lib/infra/logging/context_utils.dart`（仮称）に追加。
4. 対象サービスで LogContext を導入し、UI トレーサとの紐付けを実装。
5. トレーシング活用ガイドを `docs/guide/` に追加し、手順やサンプルコードを掲載。

## 検証計画
- 単体テストで LogContext がネストした場合も正しいコンテキストが維持されることを確認。
- デバッグ実行で UI 操作 → Service → Infra のログに同一 `flowId` が付くか確認。
- Long-running 処理で LogContext がリークせずに終了することをログで確認。

## リスク / 留意事項
- Zone を多用するとパフォーマンス影響が出る可能性 → 対象を重要フローに限定。
- コンテキスト ID の生成・伝播の実装ミスでログが結び付かない可能性 → ユニットテストとレビューで担保。
- トレーシング ID に PII が含まれないよう注意する。

## 成功指標
- トレーシング導入フローで障害発生時に関連ログが即座に特定できた事例。
- ガイドライン整備後、他チームからトレーシング利用の問い合わせが増加。
- `LogContext` 利用コードに対するコードレビュー指摘が減少（パターンが定着）。
