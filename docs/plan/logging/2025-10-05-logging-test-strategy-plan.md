# ロギングテスト戦略整備計画 (2025-10-05)

## 背景
- 現状のユニットテストではログ出力を検証しておらず、意図しないログ変更や大量出力の回帰を検知できない。
- DI 移行後は `LoggerContract` をモック化しやすくなるため、テスト指針を整備する好機である。

## 目的
- ログ出力を検証するテストユーティリティとガイドラインを整備し、重要フローでログが正しく出力されることを保証する。
- 大量ログや欠落ログといった回帰を CI で検知できる態勢を整える。

## ゴール
- テスト用の `FakeLogger` / `SpyLogger` が `test/support/logging/` に追加されている。
- 代表的なテストケース（成功/失敗）でログ検証が実装されている。
- テストガイドラインにログ検証のベストプラクティスが追記されている。

## スコープ外
- E2E/Integration テスト環境でのログ収集（必要に応じて別計画）。

## 対応方針
1. **ユーティリティ整備**
   - `LoggerContract` を実装した `FakeLogger`（非同期対応）と `SpyLogger`（記録用）を作成。
   - Matcher/Assertion ヘルパー（例: `expectLog(level, messageContains: ...)`）を提供。
2. **テストへの適用**
   - Service 層の代表テスト（例: `menu_service_test.dart`）でログ検証を追加。
   - 例外ハンドリング時の `log.e` / `log.f` を検証するケースを用意。
3. **ガイドライン更新**
   - `docs/standards/testing.md`（仮称）にログ検証のパターン・注意点を追記。
   - CI チェックリストにログ検証を含むことを検討。

## 作業手順
1. テストユーティリティの設計（同期/非同期対応、Queue 処理など）をまとめる。
2. `FakeLogger` / `SpyLogger` を実装し、共通ヘルパーを提供。
3. 代表的な Service テストにログ検証を組み込み、使用例を整備。
4. テストガイドライン/ドキュメントを更新し、レビューポイントを追加。

## 検証計画
- ユニットテストで `FakeLogger` が複数スレッド/非同期処理にも対応できるか確認。
- ログ検証テストで意図的にメッセージを変えて失敗させ、エラーメッセージが分かりやすいかレビュー。
- CI 実行で追加テストが安定して通ることを確認。

## リスク / 留意事項
- 非同期ログがテストで取りこぼしやすいため、タイムアウトや await を適切に設定。
- ログ内容変更が頻繁な箇所では過度に厳しいアサーションを避け、部分一致や構造検証を採用。
- テストユーティリティの API が複雑になると採用が進まないため、シンプルなインターフェースを心掛ける。

## 成功指標
- 最初の対象テストでログ回帰を検知できた事例が報告される。
- コードレビューでログ検証追加が自然に行われるようになる。
- CI 上でログ検証テストが 1 ヶ月以上安定して継続実行されている。
