# 構造化ログフィールド標準化計画 (2025-10-05)

## 背景
- ロギング基盤は `fields` で構造化データを付与できるが、プロジェクト全体で統一されたキー設計が存在せず情報量にばらつきがある。
- 重要イベントで共通フィールドを揃えると、ログ検索・ダッシュボード化・監視設定が容易になる。

## 目的
- ログに付与する共通フィールドの標準を策定し、主要レイヤーで一貫したメタデータを提供する。
- 既存ログの主要イベントに標準フィールドを追加し、検索性と分析性を向上させる。

## ゴール
- 共通フィールド設計書（キー名・型・例）が `docs/standards/logging-structured-fields.md` に追加されている。
- Order/Inventory/Menu の代表的なログイベントで標準フィールドが追加されている。
- ログ検索クエリ（例: `flowId`, `requestId`）がガイド化されている。

## スコープ外
- BI/可視化ツールへのダッシュボード構築は別計画。
- 外部サービス連携用の JSON スキーマ定義。

## 対応方針
1. **フィールド候補の整理**
   - ユーザー ID、店舗 ID、リクエスト ID、フロー ID、オペレーション種別などを候補にリストアップ。
   - 既存ログから頻出データを抽出し、共通化の効果が高いものを優先。
2. **ガイドライン策定**
   - フィールド命名規則（snake_case）と型のルール（文字列/数値/配列）を定義。
   - 任意フィールドと必須フィールドを分類し、レイヤー毎の適用範囲を明示。
3. **段階的導入**
   - まずは Service 層で標準フィールドを適用し、UI / Infra へ拡張。
   - `fields` のマージユーティリティ（`LogFieldsBuilder` 仮称）を用意し、再利用性を高める。

## 作業手順
1. 調査: 既存ログメッセージから共通フィールド候補と課題を抽出。
2. ガイドライン文書を作成し、レビューで合意。
3. `LogFieldsBuilder`（ヘルパークラス）を `lib/infra/logging` に追加。
4. Order/Inventory/Menu サービスの主要イベントに標準フィールドを追加。
5. ガイドにサンプルクエリと運用例を追記。

## 検証計画
- 単体テストで `LogFieldsBuilder` がフィールドマージ・マスキングを正しく行うことを確認。
- ログ出力の JSON 表現を検証し、キー重複や不正値がないことを確認。
- Kibana / Supabase ログビューアで新フィールドを用いた検索が機能するか手動確認。

## リスク / 留意事項
- フィールド追加によりログサイズが増大 → 重要度の低いフィールドは任意扱いとし、過剰な追加を避ける。
- PII 取り扱い → ユーザー識別子はハッシュ化やトークン化を検討。
- 既存ログとの差異 → リリースノートで変更を告知し、過去クエリとの互換性を整理。

## 成功指標
- 新フィールドを用いた障害調査で検索時間が短縮されたという定性的フィードバック。
- ログビューア上で標準フィールドの可視化ができるダッシュボード（暫定）が作成されている。
- コードレビューで標準フィールドの利用がチェック項目に追加されている。
