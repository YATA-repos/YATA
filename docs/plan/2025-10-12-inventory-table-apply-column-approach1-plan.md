# 在庫テーブル適用列可視化改善（アプローチ1）実装計画

## 背景と目的
- 在庫管理画面の `_InventoryTable` において、調整確定操作（適用ボタン）が水平スクロールしないと見えず、操作ミスや業務遅延が発生している。
- アプローチ1「操作列のコンパクト化と列再編」を採用し、主要操作を常時表示させると同時にテーブル情報の優先順位を整理する。

## スコープ
- 対象画面: `InventoryManagementPage`（Windows/タブレット共通）
- 対象コンポーネント: `_InventoryTable`, `YataDataTable.fromSpecs`, 在庫行スペック/ビルダー
- 対象外: 在庫データ取得API/Repository層の仕様変更、在庫以外のテーブルUI

## 完了条件
- 調整/適用セルが横スクロール無しで常時表示され、業務上必要な主要情報（数量、状態、調整値）が確認できる。
- 既存の在庫調整フロー（ステッパー、直接入力、適用操作）が保持される。
- 補助情報(閾値/更新日時など)がツールチップ/詳細表示で参照可能。
- 主要パスのウィジェットテストまたはゴールデンテストでレイアウト崩れが検出できる。
- アクセシビリティ（キーボード操作/フォーカス移動）が保証され、リリースノート下書きが用意される。

## 実装方針概要
1. 列再編: 「数量・状態」列と「調整/適用」列の 2 列構成にリデザイン。`InventoryTableColumnSpec` 相当の定義を再構築する。
2. 情報圧縮: 在庫状態や閾値などの補助情報をツールチップ/折りたたみ詳細として提供し、セル幅を確保する。
3. 操作セル統合: ステッパー、直接入力、適用ボタン（アイコン化）を単一セルにまとめ、Riverpod状態との連携を維持する。
4. i18n/テーマ対応: ラベル短縮・翻訳キー更新、テーマトークンの再利用でレスポンシブに調整する。

## 詳細タスク
1. **要件確定・デザイン同期**
   - デザインチームとFigmaモック/コンポーネント仕様を確定。
   - 補助情報の表示方式（ツールチップ内容、詳細折りたたみのトリガー）をUX観点で決定。
2. **既存実装の影響調査**
   - `lib/features/inventory/presentation/pages/inventory_management_page.dart` の `_InventoryTableState` と `YataDataTable.fromSpecs` 利用箇所を確認。
   - 在庫行ビルダー（例: `InventoryRowViewModel`/`InventoryTableRowSpec` が存在する場合）を把握し、必要なデータ/翻訳キーを洗い出す。
3. **データ/定義更新**
   - 在庫行DTO/モデルに追加情報の有無を確認し、不足する補助情報があれば既存プロパティから再利用またはService層で加工する。
   - 列仕様クラスのフィールド整理（表示幅、整列、ツールチップデータ）とユーティリティ更新。
4. **UIレイアウト刷新**
   - `YataDataTable` の列構築ロジックを更新し、新しい2列レイアウトに合わせた `DataColumn`/`DataCell` を作成。
   - 数量・状態セル: 状態ラベル/アイコンと数量表示をコンパクトに配置。必要に応じて`Wrap`や`Flex`を検討。
   - 調整/適用セル: ステッパー、数値入力、適用アイコンボタンを `Row` 内で統合し、フォーカス順序を定義。
5. **補助情報のUI実装**
   - 閾値/更新日時などを `Tooltip` または `Popover` 相当で表示。タップ/ホバー時のアクセシビリティ文言を翻訳ファイルに追加。
   - 詳細表示を行う場合は、`AnimatedSwitchable` 等を用いてセル内折りたたみを実装。
6. **ステート連携とアクション確認**
   - 既存Riverpodコントローラ（例:`inventoryAdjustmentControllerProvider`）との連携が壊れないよう、イベントハンドラを再配線。
   - 適用ボタンをアイコン化した際の `tooltip`, `semanticLabel` を設定。
7. **翻訳/コピー更新**
   - `assets/i18n/ja.json` / `en.json` の該当キー更新。短縮ラベルやツールチップ文言を追加。
   - ドキュメント（操作説明、リリースノート草案）を `docs/updates/` などに追記。
8. **テスト整備**
   - 既存のウィジェットテストを更新し、列構成変更に対応。
   - 新規テスト: 調整セル内ボタンの可視性、ツールチップ表示、キーボード操作時のフォーカス遷移。
   - ゴールデンテストで主要画面幅（デスクトップ / タブレット）を追加検証。
9. **QA/アクセシビリティ検証**
   - Windows実機/エミュレータでの幅調整確認。
   - キーボード操作（Tab/Shift+Tab）、スクリーンリーダー読み上げ、ダークモードの確認。
   - ドキュメントと不具合チケットのリンクを整理し、リリース判定会に共有。

## リスクと対応策
- **レイアウト崩れ**: DataTableレイアウト変更に伴う高さ/余白崩れ。→ ゴールデンテストと実機確認を早期に実施。
- **操作性劣化**: セル統合によりステッパー操作が窮屈になる可能性。→ プロトタイプレビューとPOによる操作確認。
- **翻訳/コピーの齟齬**: ラベル短縮で意味が伝わらない恐れ。→ 翻訳レビューと現場メンバーへの確認ミーティング設定。
- **パフォーマンス影響**: セル内ウィジェット増加による再ビルドコスト。→ `const`指定、`ProviderScope`の最小化、`debugProfilePaintsEnabled` でモニタリング。

## スケジュール目安
- Day 0: ヒアリング・デザイン確定・技術調査
- Day 1: 列仕様/データ層の更新、UIラフ組み
- Day 2: 操作セル・補助情報実装、テスト更新
- Day 3: QA・アクセシビリティ検証、ドキュメント更新、レビュー対応

## フォローアップ
- アプローチ1適用後のユーザーフィードバックを収集し、必要であればアプローチ2の固定列スパイクに進む判断材料とする。
- 別途 `docs/draft/inventory_table_focus_background_analysis.md` の改善タスクと整合を取り、フォーカス演出の統一を図る。
