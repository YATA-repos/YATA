# 注文番号表示コード刷新計画 (2025-09-30)

## 1. 背景
- 現行の注文番号 (`order_number`) はチェックアウト時にのみ採番され、カート状態では `null` のため UI 上は「未割り当て」表示になる。
- カート段階から識別しやすい番号を提示したいが、既存フォーマット（タイムスタンプ+乱数）は視認性が低く、早期表示にも向いていない。
- 案Aとして「カート作成時に 4 文字の表示用コードを付与し、そのまま正式注文へ引き継ぐ」方針を採用する。

## 2. 目的
- `order_number` のフォーマットを **大文字英字と数字の混在 4 文字** (`^[A-Z0-9]{4}$`) に刷新する。
- カート生成直後からコードを付与し、UI 表示と検索の利便性を向上させる。
- 会計時にコードを再発行せず引き継ぐことで、UI とバックエンド間で番号の一貫性を保つ。
- 既存機能（履歴検索、ステータス管理、分析など）が新フォーマットでも問題なく動作する状態を確認する。

## 3. スコープ
### 3.1 Flutter アプリ側
- 採番ロジックの変更と、カート作成フローへの組み込み。
- 既存画面（注文管理/状況/履歴）の表示確認と文言調整。
- 検索・フィルタ機能の動作確認（フォーマットが短くなる影響）。
- 単体テスト／サービス層テストの更新。

### 3.2 Supabase (バックエンド)
- `orders.order_number` カラムの制約・インデックス見直し。
- カート判定ロジック (`order_number IS NULL`) に依存するクエリの改修。
- マイグレーション手順およびロールバック方針策定。

### 3.3 ドキュメント / オペレーション
- 既存の仕様・設計ドキュメント更新。
- 運用手順書の更新（番号体系の説明、トラブルシューティング）。

## 4. 新フォーマット仕様
| 項目 | 内容 |
| --- | --- |
| 形式 | `^[A-Z0-9]{4}$` (大文字英字 + 数字の 4 文字) |
| 生成方法 | CSPRNG (`Random.secure()`) で0-35の整数を生成し、Base36 (0-9, A-Z) へ変換。|
| 衝突対策 | Supabase 側で `UNIQUE` 制約 (NULL 許容) を設定。生成時に重複例外が出た場合は再試行する実装を行う。|
| 付与タイミング | カート生成 (`CartManagementService.getOrCreateActiveCart`) 時。既存レコードで `order_number` が空の場合は補填。|
| 永続化 | `order_number` フィールドにそのまま保存。チェックアウト時に再発行しない。|
| 互換性 | 旧フォーマットを保持した既存注文はそのまま利用可。新旧混在を許容する。|

## 5. 実装タスク

### 5.1 共通ユーティリティ
1. `lib/shared/utils/order_identifier_generator.dart` へ短いコード生成 API を追加（例: `generateDisplayCode({int length = 4})`）。
   - 既存の Base62 生成関数を流用せず、新たに Base36 (0-9, A-Z) を実装。
   - 例外ハンドリング：length <= 0 のガード、`Random.secure()` 使用。
2. テスト (`test/shared/utils`) を新フォーマット用に更新。

### 5.2 サービス / リポジトリ層
1. `CartManagementService.getOrCreateActiveCart`
   - カート取得後に `order.orderNumber` が `null` / 空なら、新しい表示コードを生成し `orderRepository.updateById` で設定。
   - 既存カートにも後追いで付与されるよう、初回呼び出し時に補填。
2. `OrderRepository.findActiveDraftByUser`
   - これまでの `order_number IS NULL` 条件を撤廃。`is_cart = true` を基準にロジックを再構成。
3. `OrderManagementService.checkoutCart`
   - 現行は `generateNextOrderNumber()` を呼び直しているため、`order.orderNumber` が空の場合のみ新規生成するよう条件分岐。
   - 今回は基本的に "上書きしない" 方針とし、フォールバック用に `orderRepository.generateNextOrderNumber()` を短いコード版に差し替え。
4. `OrderRepository.generateNextOrderNumber`
   - 4 文字コードを返すように変更。衝突時 (`orders.order_number` UNIQUE) は最大リトライ回数を設定。
5. `OrderSearchRequest` / `OrderHistoryController` / `OrderStatusController`
   - フォーマット変更に伴うロジック変更は不要だが、検索ヒントやコメントの更新。

### 5.3 UI 層
- 注文管理 / 注文状況 / 注文履歴の表示ラベルを確認。
- 文言を「受付コード」に統一し、旧フォーマットはフォールバック表示。
- スナックバーやダイアログでコードが短い形式でも自然に見えるか確認。

### 5.4 テスト更新
- `order_identifier_generator_test.dart` を新フォーマット対応に書き換え。
- `order_repository_test.dart` / `order_management_service_test.dart` 等で期待フォーマットを更新。
- カート生成時にコードが自動付与される E2E／統合テストを追加（可能なら UI テスト、最低でもサービス層テスト）。

### 5.5 データ移行
1. 既存カート（`is_cart = true`）で `order_number` が `NULL` のものに対し、バックフィルスクリプトで 4 文字コードを付与。
   - Supabase SQL: `UPDATE orders SET order_number = <generated> WHERE is_cart = true AND order_number IS NULL;`
   - 実装中は、Flutter 側で補填処理を idempotent にしておく（重複防止）。
2. 既存注文で旧フォーマットのものはそのまま残し、検索や表示で混在を許容する。

### 5.6 ドキュメント更新
- `docs/draft/2025-09-30-order-number-format-impact.md` を参照し、関連箇所の更新を実施。
- 新フォーマット仕様を `docs/standards` などの規約ドキュメントへ反映。

## 6. リスクと対応策
| リスク | 説明 | 対応策 |
| --- | --- | --- |
| コード衝突 | 4 文字だと 1/1,679,616 通り。高負荷環境では衝突可能性あり。 | UNIQUE 制約 + リトライを実装。必要なら長さ拡張 (6 文字) も検討。 |
| 旧フォーマットとの混在 | 履歴画面などで表示形式が混在し戸惑う可能性。 | 表示ラベルに説明を追加。検索も旧フォーマットを許容する。必要ならフォーマット別のタグ表示。 |
| カート判定のロジック漏れ | `order_number` null 判定を無効化した際に他機能が影響を受ける可能性。 | 全コードベースを grep し、`order_number == null` に依存している箇所を網羅的に更新。 |
| 仕様逸脱 | 外部資料やオペレーションマニュアルが旧フォーマットのまま。 | 移行完了前に関連資料を更新。サポートへの周知を行う。 |

## 7. 完了条件
- 新規カート作成時に UI 上で 4 文字コードが表示され、会計後も同コードが保持される。
- Supabase に `orders.order_number` へ **UNIQUE 制約（NULL 許容）** が追加されており、アプリ側は衝突検知時にリトライして最終的に採番成功する。
- 注文履歴検索・注文状況更新など主要シナリオが新フォーマットで問題なく動作する。
- 既存ドキュメント・テストがすべて更新済み。
- ロールバック手順を含む運用側資料が準備できている。

---

### メモ
- 既存の計画書 `2025-09-30-order-number-format-revamp.md` は旧フォーマット（タイムスタンプ+乱数）刷新用。今回の表示コード刷新と重複するため、不要になった項目は整理を検討。
- 表示コードの長さやフォーマットは将来の要件に応じて変更しやすいよう、生成ロジックをユーティリティ化し DI 可能な設計を推奨。
