# 注文管理パフォーマンス改善フォローアップ計画（2025-10-05）

## 背景
- `_logs/app-20251005-03.log` の新規計測で、初回ロード・カート操作・会計処理における遅延要因とログ上の WARN が具体化した。
- 既存の「サービス層最適化計画」では網羅できなかった、セッション同期の待ち時間・逐次クエリの多重発行・Enum 不整合再発といった追加課題が確認された。
- 本ドキュメントでは、これらの課題を短期で是正するための追加プランを定義する。

## 発見された主な課題
| 区分 | 症状 | 根本原因 |
| --- | --- | --- |
| 初期ロード | `ui.order.load_initial_data` が 2.66s | Supabase セッション `tokenRefreshed` 待ちで UI フローがブロック `_logs/app-20251005-03.log:19`, `:24`, `:54` |
| カート操作 | `add_menu_item` 811ms / `update_item_quantity` 677ms | `QueryUtils` が同一 `user_id` フィルタを多重適用し、在庫確認→材料取得→金額更新が逐次 API になっている `_logs/app-20251005-03.log:63-147` |
| 会計処理 | `ui.order.checkout` 1240ms (サービス層 923ms) | 在庫検証→材料消費→新規カート生成を直列実行し、各ステップで再フェッチ `_logs/app-20251005-03.log:170-249` |
| データ整合 | WARN: `order_status_enum` が `"canceled"` を受け付けずリトライ | クライアントと DB のステータス表記揺れ `_logs/app-20251005-03.log:257` |

## 改善方針概要
1. **セッションウォームアップ**: 認証完了時に Supabase セッションを安定化させ、注文画面遷移前に `tokenRefreshed` を済ませる。
2. **カート操作 RPC 化**: 在庫検証・材料消費・合計再計算を Supabase RPC もしくはバッチ API に統合し、ケイデンスを 1 往復に短縮する。
3. **クエリビルダー整理**: `QueryUtils` のフィルタ多重適用を防ぐ仕組みを導入し、冪等実行で不要なログ・クエリを削減する。
4. **Enum 表記統一**: フロント／サービス層でステータス名を強制正規化し、WARN リトライを排除する。
5. **計測と回帰防止**: 改善後の P95 指標を自動計測し、再発時に検知するテスト・メトリクスを整備する。

## アクションプラン

### 1. セッションウォームアップ
- `AuthService` にセッションステータス監視を追加し、`initialSession`/`tokenRefreshed` 完了後に `OrderManagementController` を初期化するガードを導入。
- ログイン成功時点で `Supabase.auth.refreshSession()` を実行し、その完了を UI ナビゲーションの条件に設定。
- `context_utils_test.dart` にセッションウォームアップのユニットテストを追加し、待機処理が確実に働くことを検証。

### 2. カート操作パイプラインの RPC 化
- Postgres 関数 `rpc_cart_mutation(cart_id, menu_item_id, qty_delta, user_id)` を設計し、在庫確認→材料更新→金額再計算→差分レスポンスを一括処理。
- `order_inventory_integration_service.dart` と `order_calculation_service.dart` から個別クエリ呼び出しを除外し、RPC 呼び出しに置き換え。
- 既存のローカルキャッシュ (`OrderContext`) を拡張し、RPC から返る差分を UI へ伝搬する。

### 3. `QueryUtils` 改修
- フィルタをハッシュキーで重複検出し、同一条件は 1 度だけ適用する仕組みを追加。
- ログ出力にクエリ ID と付与フィルタ一覧を集約して記録し、以降の計測でクエリ回数を可視化。
- 影響範囲のユニットテスト（例: `query_utils_test.dart`）に重複防止ケースを追加。

### 4. Enum 表記統一
- `order_management_service.dart` 内のステータスマッピング層で `canceled` → `cancelled` を正規化する関数を追加。
- Supabase 側のマイグレーション（enum 値の別名追加または view 化）を検討し、アプリからは新名称のみ送出。
- WARN ログが発生しないことをチェックするモニタリングルールを Logging 基盤に追加。

### 5. 計測と回帰防止
- `order_management_tracing.dart` に `TimelineTask` を追加し、初期ロード／カート操作／会計処理の各 P95 を計測可能にする。
- `test/infra/logging/context_utils_test.dart` にログ構造の回帰テストを拡張し、必須フィールドが欠落しないことを検証。
- GitHub Actions で `_logs/` の最新計測を解析するスクリプトを追加し、しきい値超過時に警告を出す。

## マイルストーン
| 期日 | 成果物 |
| --- | --- |
| 2025-10-06 | セッションウォームアップ実装＋ユニットテスト、初期ロード P95 1.0s → 0.5s 以下を目標に再計測 |
| 2025-10-08 | RPC ベースのカート操作リリース、連続操作ログで P95 ≤ 250ms を確認 |
| 2025-10-09 | Enum 正規化＆ QueryUtils 改修完了、WARN/重複クエリが 0 であることをログ確認 |
| 2025-10-10 | 自動計測・CI 監視導入、改善レポート更新 |

## 検証方法
- Flutter DevTools `/ Performance` タブ + Supabase ログで実測値を取得。
- Integration テスト（カート追加→数量変更→会計）を自動化し、完了時間と RPC 呼び出し回数をログ収集。
- Slack あるいは Sentry 通知に WARN ゼロを条件としたチェックを追加し、デグレを即検知。

## リスクと備考
- RPC 導入に伴い DB 権限とデプロイ手順の影響範囲が拡大するため、 staging で十分な検証を実施する。
- セッションウォームアップでナビゲーション順序を変更する際、既存の UI フローパターン (Deep Link 等) への影響に注意。
- Enum 正規化後も旧バージョンクライアントが存在するケースを考慮し、一時的に双方向マッピングを維持する。

## 次アクション
1. セッションハンドリング改善の実装ブランチを作成し、初期ロードの再計測を実施。
2. Supabase RPC の仕様案とマイグレーションを `docs/design/` にドラフトし、レビューを依頼。
3. QueryUtils 改修と Enum 正規化のタスクを issue 化してチームへ共有。

**この実装は完了しています**