# 注文ステータス統合計画（2025-09-28）

注文履歴と注文状況の UI におけるステータス表記揺れを解消し、オペレーションフローを「準備中 / キャンセル済み / 完了」の 3 状態に統合するための実装計画を示す。

- 対象: `lib/core/constants/enums.dart`、`lib/features/order` 配下のサービス・プレゼンテーション層
- 関連ドキュメント: `docs/draft/2025-09-28-order-status-state-inconsistency.md`

## 背景

- UI 間で「完了」と「提供済み」など表記が分岐している。
- Checkout 直後の `confirmed` 注文が注文状況ページで表示されず、キッチンが見落とすリスクがある。
- Enum には `ready` や `delivered` など未使用項目が残っており、運用との乖離が大きい。

## ゴール

1. アプリ内で参照するステータスを「準備中」「キャンセル済み」「完了」の 3 つに統一する。
2. 注文履歴・注文状況 UI が同一の状態セットと文言を利用する。
3. サービス層とデータ層で旧ステータス値を安全に移行し、後方互換を確保する。

## 非目標

- 今後導入を検討している細分化ステータス（提供準備完了など）の設計。
- バックエンド API の大規模リファクタリング（必要最小限のマイグレーションのみ対象）。

## 新ステータスモデル

| 新状態キー | 表示名 | 旧状態の集約対象 | 備考 |
| --- | --- | --- | --- |
| `inProgress` | 準備中 | `pending`, `confirmed`, `preparing` | キッチンで処理中の注文を含む待機〜調理中の一連の状態を代表。 |
| `cancelled` | キャンセル済み | `cancelled`, `refunded` | 会計キャンセルと返金完了を統合して扱う。 |
| `completed` | 完了 | `ready`, `delivered`, `completed` | 提供完了も含めて一括管理。 |

- `OrderStatus` enum は上記 3 値のみ積極利用。旧値は `@Deprecated` コメントを付与し、段階的に削除予定。
- UI 表記は `OrderStatusPresentation`（新規ユーティリティ）から取得し、ハードコードを排除する。

## 実装フェーズ

### Phase 0: 準備（ドキュメント・マッピング定義）
- ステータス変換マップ `OrderStatusMapper` を `lib/features/order/shared` に追加。
- `docs/standards/` に状態仕様の更新版を記載し、開発チームへ告知。

### Phase 1: データレイヤーの移行
- Supabase テーブルの `status` カラムを 3 値へ変換する SQL マイグレーションを用意。
- 既存データをマッピングして更新（例: `UPDATE orders SET status = 'in_progress' WHERE status IN ('pending','confirmed','preparing');`）。
- `OrderModel.fromJson` で旧値を受け取った際に新値へフォールバックする互換コードを追加。

### Phase 2: サービスレイヤーの更新
- `OrderManagementService` / （旧）`OrderService` / `KitchenOperationService` のステータス更新ロジックを 3 状態のみ許容するよう修正。
- Checkout 完了時に `inProgress` を設定。提供完了・キャンセル操作も新値を利用。
- API 呼び出し前後で `OrderStatusMapper` を必ず通すように共通化。

### Phase 3: プレゼンテーション層の統一
- `order_history_page.dart` と `order_status_page.dart` の表示文言を `OrderStatusPresentation` 経由に変更。
- セクション/フィルタの状態セットを共通化（順序: 準備中 → 完了 → キャンセル済み）。
- アクションボタンの文言を「完了にする」「キャンセルにする」へ統一し、トースト/ダイアログも同じ語彙を利用。

### Phase 4: クリーンアップ
- 未使用となった旧ステータスの分岐・テストを削除。
- `@Deprecated` な列挙値の削除タイムラインを決定し、別イシューで追跡。

## 受け入れ条件

- 注文履歴と注文状況の双方でステータスが「準備中 / 完了 / キャンセル済み」だけ表示される。
- Checkout 直後の注文が注文状況画面に表示される。
- ステータス更新操作（完了・キャンセル）が正しい値で保存され、履歴にも反映される。
- Analyzer/Lints に新たな警告・エラーが増えない。

## タスクリスト（抜粋）

- [x] ステータス変換マップとプレゼンテーションユーティリティを追加。
- [ ] データマイグレーション SQL を作成し、ステージング環境で検証。
- [x] サービス層のステータス更新ロジックを 3 状態へ制限。
- [x] UI 層（履歴・状況ページ）の文言とフィルタを共通化。
- [x] 旧状態値の後方互換テスト＆ドキュメント更新。

## 進捗メモ（2025-09-30）

- `OrderStatusMapper` と `OrderStatusPresentation` を導入し、旧値を安全に 3 状態へ正規化する実装を完了。
- `OrderManagementService` 系列および注文履歴・状況 UI がすべて `inProgress / completed / cancelled` のみを使用するよう更新済み。
- テストコードを新仕様に合わせて修正し、`flutter test test/features/order/...` で正常動作を確認。

## リスクと緩和策

- **データ整合性**: 旧状態が残る可能性 → マイグレーション後に状態別件数をダッシュボードで確認し、差異があればログを解析。
- **旧クライアントの互換性**: 古いアプリが旧値を送信 → `OrderStatusMapper` で新値へ変換し、2 リリース後に削除予定で告知。
- **UI キャッシュ**: ローカルキャッシュに旧文字列が残る → 初回同期時に強制更新またはキャッシュクリア処理を挿入。

## 検証計画

1. 単体テスト: ステータス変換ヘルパーとサービスレイヤーの遷移制御を追加。
2. Widget テスト: 注文履歴・注文状況で同一状態セットが描画されることを確認。
3. 統合テスト: Checkout → 完了 / キャンセル → 履歴表示の一連フローを再生。
4. ステージング検証: Supabase のバックアップを復元し、マイグレーション SQL を適用後に UI の整合性を確認。

## ロールバック方針

- マイグレーション実行前のバックアップを確保し、問題が発生した場合はロールバック。
- 追加したユーティリティと新ステータスへの参照を revert すれば、旧挙動に戻せる。

## フォローアップ

- 状態細分化（「提供準備完了」など）が必要になった場合の設計指針を別ドキュメントで検討する。
- 旧ステータス削除イシューを作成し、タイムラインと影響範囲を明文化する。
