# 注文詳細モーダル オーバーレイクローズ対応 実装計画

## 概要

UI/UXタスク **UI/UX-Enhancement-14** に基づき、注文履歴画面で表示される注文詳細モーダルを背景オーバーレイのクリックで閉じられるようにする実装計画。デスクトップ・モバイルの双方で一般的なモーダル挙動へ揃え、操作性を改善する。

## 背景・現状

- `_OrderDetailDialog` は `Stack` 上に直接配置され、暗い半透明背景を `Container` で描画している。
- 現状の背景 `Container` はクリック/タップイベントを処理しておらず、モーダル外をタップしても `onClose` が呼ばれない。
- 内側の `Material` にフォーカスが残るため、モーダルを閉じる手段は右上のクローズボタンのみで、片手操作やマウス操作での離脱コストが高い。

## 成功条件

- 背景オーバーレイをクリックまたはタップすると `OrderHistoryController.clearSelectedOrder()` が呼ばれ、モーダルが閉じる。
- モーダル本体（`Material` 内）をクリックした場合は閉じず、既存操作が阻害されない。
- スクロール・レスポンシブ挙動・フォーカス管理が既存と同等に維持される。
- デスクトップ(マウス)・モバイル(タップ)双方で挙動を確認し、想定通りに動作する。

## 影響範囲

- **主要ファイル**: `lib/features/order/presentation/pages/order_history_page.dart`
- **副次的影響**: `OrderHistoryController` のハンドラ呼び出し経路の確認（既存 `onClose` を再利用）
- **テスト**: 新規ウィジェットテストを `test/features/order/presentation/` 配下へ追加予定

## 実装方針

1. **UI構造の整理**
   - `_OrderDetailDialog` を内部的に `Stack` 構造へ変更し、`Positioned.fill` で背景レイヤーを独立させる。
   - 背景レイヤーとモーダル本体を明確に分離し、ヒットテスト処理を制御しやすくする。

2. **イベントハンドリング**
   - 背景レイヤーに `GestureDetector`（`behavior: HitTestBehavior.opaque`）または `ModalBarrier` を適用して `onTap: onClose` を呼ぶ。
   - モーダル本体を `GestureDetector`（`behavior: HitTestBehavior.translucent`, `onTap: () {}`）で包み、背景へのイベントバブリングを抑止する。

3. **アクセシビリティ/UX 配慮**
   - 既存のクローズボタンとショートカット（もしあれば）を残し、多様な操作方法を維持する。
   - フォーカスが背景タップで失われる際に例外が出ないことを確認する。

4. **コードスタイル**
   - 既存のYataデザイントークン（`YataSpacingTokens` など）をそのまま再利用し、スタイル差分を最小限にする。

## 実装ステップ

1. `_OrderDetailDialog` の `build` 実装をリファクタリングし、`Stack` と `GestureDetector` を導入する。
2. 背景タップで `onClose` が呼ばれることを確認するためのウィジェットテストを追加する。
3. 手動動作確認（デスクトップ: クリック、モバイルシミュレーション: タップ）を実施する。
4. 既存ドキュメント/TODOの参照を更新し、タスク完了後に TODO エントリを整理する（実装フェーズの作業）。

## テスト計画

- **ウィジェットテスト**:
  - `pumpWidget` で `OrderHistoryPage`（または `_OrderDetailDialog` 単体）を描画し、背景領域をタップ → `onClose` が1回呼ばれることを検証。
  - モーダル本体をタップしても `onClose` が呼ばれないことを検証。

- **手動テスト**:
  - PC: マウスクリックで背景を複数回クリックし、モーダルが都度閉じることを確認。
  - モバイル（エミュレータ）: タップ操作で同様に確認。連続タップ/高速タップでも例外が出ないことを確認。

## リスクと対策

| リスク | 影響 | 対策 |
| --- | --- | --- |
| 背景タップでスクロールが効かなくなる | ページ全体の操作性低下 | 背景 `GestureDetector` の `behavior` を `opaque` に設定しつつ、モーダル非表示時は既存スクロール構造を維持 |
| モーダル本体タップで誤って閉じる | 操作ミスによる UX 低下 | モーダル本体ラッパーでイベントを吸収し、`onTap` を空実装で設定 |
| テストで背景領域を指定しにくい | 自動化難度 | テスト時に `find.byKey` や `find.byWidgetPredicate` を用意するため、背景レイヤーに `Key` を追加 |

## スケジュール目安

- 実装: 0.5日
- テスト（自動＋手動）: 0.5日
- 合計: 1日以内（XSタスク想定通り）

## アウトオブスコープ

- Escapeキーなどキーボードショートカットの導入
- モーダルを共通コンポーネントへ抽象化するリファクタリング
- 注文履歴以外のモーダルへの横展開（別タスクで対応）
