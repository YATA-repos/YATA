# Order Feature - サービス依存関係図

このドキュメントは`lib/features/order/services/`配下のサービス層の依存関係を視覚化したものです。

## 現状のサービス依存関係

```
┌─────────────────────────────────────────────────────────────────┐
│                     Presentation Layer                           │
│                                                                   │
│  ┌──────────────────────┐  ┌──────────────────────┐            │
│  │OrderManagement       │  │OrderStatus           │            │
│  │Controller            │  │Controller            │            │
│  │(1,680行)             │  │(247行)               │            │
│  └──────────────────────┘  └──────────────────────┘            │
│           │                          │                           │
└───────────┼──────────────────────────┼───────────────────────────┘
            │                          │
            ▼                          ▼
┌───────────────────────────────────────────────────────────────────┐
│                       Facade Layer (3層目)                         │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐           │
│  │CartService   │  │OrderService  │  │KitchenService│           │
│  │(76行)        │  │(158行)       │  │(89行)        │           │
│  │単なる委譲    │  │ラッパー+     │  │単なる委譲    │           │
│  │              │  │Realtime      │  │              │           │
│  └──────────────┘  └──────────────┘  └──────────────┘           │
│         │                  │                 │                    │
└─────────┼──────────────────┼─────────────────┼────────────────────┘
          │                  │                 │
          ▼                  ▼                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│                     Management Layer (2層目)                         │
│  ┌───────────────────────┐      ┌───────────────────────┐          │
│  │CartManagement         │      │OrderManagement        │          │
│  │Service (628行)        │◄─────┤Service (630行)        │          │
│  │                       │      │                       │          │
│  │- カート取得・作成     │      │- チェックアウト       │          │
│  │- アイテム追加・更新   │      │- 注文キャンセル       │          │
│  │- 在庫検証             │      │- 注文履歴取得         │          │
│  └───────────────────────┘      └───────────────────────┘          │
│             │  │  │                       │  │  │                   │
│             │  │  └───────────────────────┘  │  │                   │
│             │  └─────────────────────────────┘  │                   │
│             └────────────────────────────────────┘                   │
│                                                                       │
│  ┌───────────────────────┐      ┌───────────────────────┐          │
│  │KitchenOperation       │      │KitchenAnalysis        │          │
│  │Service (287行)        │      │Service (402行)        │          │
│  │                       │      │                       │          │
│  │- ステータス更新       │      │- 完成予定時刻計算    │          │
│  │- キッチン操作         │      │- 負荷状況分析         │          │
│  └───────────────────────┘      └───────────────────────┘          │
└────────────┬──────────────┬──────────────┬─────────────────────────┘
             │              │              │
             ▼              ▼              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         Core Layer (1層目)                           │
│  ┌───────────────────────┐  ┌───────────────────────┐              │
│  │OrderCalculation       │  │OrderStock             │              │
│  │Service (116行)        │  │Service (203行)        │              │
│  │                       │  │                       │              │
│  │- 金額計算             │  │- 在庫確認             │              │
│  │- 税額計算             │  │- 材料消費             │              │
│  │- 割引適用             │  │- 在庫復元             │              │
│  └───────────────────────┘  └───────────────────────┘              │
│             │                          │                             │
└─────────────┼──────────────────────────┼─────────────────────────────┘
              │                          │
              ▼                          ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      Repository Layer                                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐              │
│  │Order         │  │OrderItem     │  │Material      │              │
│  │Repository    │  │Repository    │  │Repository    │              │
│  └──────────────┘  └──────────────┘  └──────────────┘              │
└─────────────────────────────────────────────────────────────────────┘
```

## 問題点の視覚化

### 1. 重複する依存関係

```
OrderManagementService ────┐
                            ├──► OrderCalculationService
CartManagementService ─────┤
                            │
                            ├──► OrderStockService
                            │
CartService ───────────────┘
```

→ `OrderCalculationService`が3箇所から依存される

### 2. Facade層の不要性

```
Controller
    │
    ▼
CartService (76行)          ← 単なるメソッド転送
    │                          (抽象化の利点なし)
    ▼
CartManagementService
```

→ 直接`CartManagementService`を呼ぶ方がシンプル

### 3. サービス間の循環的依存（潜在的）

```
OrderManagementService ──► CartManagementService
           │                        │
           └────────────────────────┘
         (両方とも同じ3つのサービスに依存)
```

## 提案されるリファクタリング後の構造

```
┌─────────────────────────────────────────────────────────────────┐
│                     Presentation Layer                           │
│  ┌──────────────────────┐  ┌──────────────────────┐            │
│  │OrderManagement       │  │OrderStatus           │            │
│  │Controller            │  │Controller            │            │
│  └──────────────────────┘  └──────────────────────┘            │
│           │                          │                           │
└───────────┼──────────────────────────┼───────────────────────────┘
            │                          │
            ▼                          ▼
┌───────────────────────────────────────────────────────────────────┐
│                       Service Layer                                │
│  ┌───────────────────────┐      ┌───────────────────────┐        │
│  │CartManagement         │      │OrderManagement        │        │
│  │Service                │      │Service (統合後)       │        │
│  │                       │      │                       │        │
│  │- カート操作           │◄─────┤- チェックアウト       │        │
│  │                       │      │- 注文管理             │        │
│  │                       │      │- Realtime機能         │        │
│  └───────────────────────┘      └───────────────────────┘        │
│             │                              │                       │
│             └──────────┬───────────────────┘                       │
│                        ▼                                           │
│  ┌───────────────────────┐  ┌───────────────────────┐            │
│  │OrderCalculation       │  │OrderInventory         │            │
│  │Service                │  │IntegrationService     │            │
│  │                       │  │(改名後)               │            │
│  └───────────────────────┘  └───────────────────────┘            │
│                                                                    │
│  ┌───────────────────────┐  ┌───────────────────────┐            │
│  │KitchenOperation       │  │KitchenAnalysis        │            │
│  │Service                │  │Service                │            │
│  └───────────────────────┘  └───────────────────────┘            │
└────────────────────────────────────────────────────────────────────┘
```

**主な変更点:**
1. ✅ Facade層（CartService, KitchenService）を削除
2. ✅ OrderServiceをOrderManagementServiceに統合
3. ✅ 依存関係を整理し、重複を削減
4. ✅ OrderStockServiceを改名（OrderInventoryIntegrationService）

**効果:**
- コードベース削減: ~240行
- 依存関係の簡素化
- DI設定の簡素化
- 可読性・保守性の向上

## 参考

詳細な分析とリファクタリング計画は `2025-refactoring-analysis.md` を参照してください。
