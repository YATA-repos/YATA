# 在庫テーブル適用列可視性改善アプローチ

**作成日**: 2025-10-12  
**対象画面**: 在庫管理画面（`InventoryManagementPage`）  
**対象コンポーネント**: `_InventoryTable` / `YataDataTable`

## 課題整理
- 適用（調整値を確定する）列がテーブル右端にあり、水平スクロールをしない限り表示されない。
- 適用列が不可視のまま操作すると、調整値が設定されてもユーザーが確定操作に気付きにくい。
- テーブル幅が広く、現行のレイアウトでは横方向の余裕がほぼないため、単純な列幅調整では根本的な解決にならない。

## UX・開発上の制約まとめ
- デスクトップ（Windows）とタブレットサイズの両方で同一UIを共有しており、横幅が狭い環境での崩れも考慮する必要がある。
- Flutter `DataTable` ベースで構築されており、列固定（pinned column）の仕組みは標準で提供されない。
- 行内に複数の操作（ステッパー、数値入力、ツールチップ、適用ボタン）があるため、操作エリアの配置変更は再ビルドコストが高い。
- 在庫数値・状態・メモなど、業務上外せない情報が多く、単純な列削除が難しい。

## 解決アプローチ案

### アプローチ1: 操作列のコンパクト化と列再編
**概要**: 適用列に至るまでの情報量を整理し、主要情報を圧縮することで横幅を確保する。

- 主な変更
  - 「在庫状況」「ステータス」「調整」を統合した 2 列構成にリファクタリング。
  - 閾値や更新日時などの補助情報はツールチップまたは折りたたみ詳細に移動。
  - 適用ボタンをアイコン化し、ステッパーと同一セル内に収める。

```
┌───────────┬──────────────┬────────────────┬─────────┐
│アイテム      │カテゴリ      │数量・状態      │調整/適用 │
├───────────┼──────────────┼────────────────┼─────────┤
│にんじん      │野菜          │12個 [適切]     │[-] ±0 [+] ✓│
└───────────┴──────────────┴────────────────┴─────────┘
```

#### 長所
- 適用操作が常時可視範囲に入り、スクロール依存が解消される。
- 列数削減により視線移動が短くなり、情報の優先順位も整理できる。

#### 留意点
- 列統合の実装はレイアウト変更が大きく、既存テストや翻訳リソースの見直しが必要。
- 補助情報の表示位置を決めるため、UX検証が必須。

### アプローチ2: 水平スクロールを維持しつつ適用列を固定表示
**概要**: Flutterで擬似的な「固定列」を実現し、右端の適用列を常時表示する。

- 実装イメージ
  - `SingleChildScrollView` 上にテーブル本体を置き、右端に `SizedBox(width: applyColumnWidth)` の固定領域を別ウィジェットとして重ねる（Stack + Positioned）。
  - スクロールと連動して行高さを揃えるため、テーブル行モデルを共有し、適用セルだけ独立描画する。
  - ホバー・選択状態を同期させるため、`Notifier` や `InheritedWidget` で状態共有。

```
┌────────────── テーブル本体 ──────────────┐┌─適用列─┐
│ …スクロール可能…                                   ││ ✓ ┆ ✔ │
└─────────────────────────────────────┘└──────┘
```

#### 長所
- 既存の列構成を大きく変えずに適用列の可視性を確保できる。
- 操作動線が現行とほぼ同じで、学習コストが低い。

#### 留意点
- `DataTable` の構造を部分的に分解して再構築する必要があり、実装複雑度が高い。
- 各行の高さ・ホバー色を同期させる実装がズレるとUI破綻のリスク。
- モバイル/タブレットでのスクロール挙動検証が不可欠。

### アプローチ3: 行選択時にフライアウト操作パネルを表示
**概要**: テーブル行は閲覧に特化し、適用操作をサイドパネルやダイアログに移す。

- 主な変更
  - 行を選択/編集ボタン押下で右側に `Drawer` 風のパネルを表示し、その中で調整値入力と適用を行う。
  - テーブル上の調整列は「編集」ボタンのみを残し、横幅を縮小。
  - 複数行の操作を想定する場合は、選択行一覧をパネル下部に表示。

```
┌──────── テーブル ────────┬─ 編集パネル ──┐
│行            │編集│…        │ 在庫: にんじん │
│…             │編集│…        │ 調整: [-] 0 [+] │
│…             │編集│…        │ [適用] [取消]   │
└───────────────┴─────────────┘
```

#### 長所
- テーブル幅の制約から解放され、主要情報を広く使える。
- 操作ステップを段階化することで、誤操作を抑制できる。
- 追加機能（履歴参照、コメント入力など）をパネル内に拡張しやすい。

#### 留意点
- 操作フローが従来と変わるため、ユーザーへの周知やチュートリアルが必要。
- パネル表示のアニメーションやレスポンシブ挙動の設計が別途必要。
- シングルウィンドウで同時に複数行を調整する運用に向かない場合がある。

## 推奨ステップ
1. デザインチームと連携し、アプローチ1・2のモックを作成してヒューリスティック評価を実施。
2. 短期改善が求められる場合はアプローチ2の技術検証（スパイク）を 1~2 日で実施し、実装コストとリスクを見積もる。
3. 長期的なUI再編も視野に入るなら、アプローチ3のプロトタイピングとユーザーテストを進行。
4. いずれの案でも、キーボード操作とアクセシビリティ（フォーカス遷移、スクリーンリーダー）を QA リストに追加する。

## メモ
- 在庫テーブル改善に関する既存ドキュメント: `docs/draft/inventory_table_ui_improvement_proposal.md`
- 適用列に関連するフォーカス/背景課題: `docs/draft/inventory_table_focus_background_analysis.md`
