# æ³¨æ–‡ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹è¡¨ç¤ºã®ç¾çŠ¶èª¿æŸ»ãƒ¡ãƒ¢

- æ—¥ä»˜: 2025-09-28
- å¯¾è±¡ãƒˆãƒ”ãƒƒã‚¯: Order History / Order Status ã®è¡¨ç¤ºã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä¸æ•´åˆ
- ä½œæˆè€…: GitHub Copilot

## 1. èƒŒæ™¯

æ³¨æ–‡å±¥æ­´ç”»é¢ã§ã¯ `OrderStatus` ã®è¡¨ç¤ºåã‚’ãã®ã¾ã¾åˆ©ç”¨ã—ã¦ãŠã‚Šã€æ³¨æ–‡çŠ¶æ³ç”»é¢ã§ã¯ã‚»ã‚¯ã‚·ãƒ§ãƒ³åã‚’ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã—ã¦ã„ã‚‹ãŸã‚ã€
"æº–å‚™ä¸­ / ç¢ºèªæ¸ˆã¿ / å®Œäº†" ã¨ "æº–å‚™ä¸­ / æä¾›æ¸ˆã¿" ã¨ã„ã†ç•°ãªã‚‹ç”¨èªãŒåŒæ™‚ã«åˆ©ç”¨ã•ã‚Œã¦ã„ã‚‹ã€‚åŠ ãˆã¦ã€ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å´ã®é·ç§»è¨­è¨ˆãŒ
`confirmed â†’ preparing â†’ completed` ã‚’æƒ³å®šã—ã¦ã„ã‚‹ã®ã«å¯¾ã—ã€å‰æ®µã® UI ã§ã¯ `confirmed` ã‚’æ‰±ã£ã¦ã„ãªã„ã€‚ç¾è¡Œå®Ÿè£…ãŒã©ã®ã‚ˆã†ã«
ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ‰±ã£ã¦ã„ã‚‹ã‹ã‚’æ•´ç†ã™ã‚‹ã€‚

## 2. èª¿æŸ»å¯¾è±¡ã‚³ãƒ¼ãƒ‰

- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å®šç¾©: `lib/core/constants/enums.dart`
- æ³¨æ–‡å±¥æ­´ UI / ãƒ­ã‚¸ãƒƒã‚¯:
  - `lib/features/order/presentation/pages/order_history_page.dart`
  - `lib/features/order/presentation/controllers/order_history_controller.dart`
- æ³¨æ–‡çŠ¶æ³ UI / ãƒ­ã‚¸ãƒƒã‚¯:
  - `lib/features/order/presentation/pages/order_status_page.dart`
  - `lib/features/order/presentation/controllers/order_status_controller.dart`
- ã‚µãƒ¼ãƒ“ã‚¹å±¤ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ“ä½œ:
  - `lib/features/order/services/order_management_service.dart`
  - `lib/features/order/services/order_service.dart`
  - `lib/features/order/services/kitchen_operation_service.dart`

## 3. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å®šç¾©ã®æ•´ç†

`lib/core/constants/enums.dart` ã® `OrderStatus` å®šç¾© (L204-L293) ã‚’åŸºã«ã€ç¾çŠ¶å‚ç…§ã•ã‚Œã¦ã„ã‚‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ•´ç†ã—ãŸã€‚

| Enum å€¤ | `value` | `displayName` | å‚™è€ƒ |
| --- | --- | --- | --- |
| `pending` | `"pending"` | å¾…æ©Ÿä¸­ | UI ã‹ã‚‰ã®ç›´æ¥å‚ç…§ç„¡ã— (ä»Šå¾Œã®å°ç·šæ¤œè¨)ã€‚ |
| `confirmed` | `"confirmed"` | ç¢ºèªæ¸ˆã¿ | `checkoutCart` å®Œäº†ç›´å¾Œã®çŠ¶æ…‹ã€‚æ³¨æ–‡å±¥æ­´ã«ã¯å‡ºã‚‹ãŒæ³¨æ–‡çŠ¶æ³ã«ã¯å‡ºãªã„ã€‚ |
| `preparing` | `"preparing"` | æº–å‚™ä¸­ | ã‚«ãƒ¼ãƒˆçŠ¶æ…‹ãŠã‚ˆã³ã‚­ãƒƒãƒãƒ³é€²è¡Œä¸­ã®æ³¨æ–‡ã‚’è¡¨ã™ã€‚æ³¨æ–‡çŠ¶æ³ã® "æº–å‚™ä¸­" ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã§ä½¿ç”¨ã€‚ |
| `ready` | `"ready"` | æº–å‚™å®Œäº† | ç¾çŠ¶ UI ã§ã¯æœªä½¿ç”¨ã€‚ã‚­ãƒƒãƒãƒ³é–¢é€£ã‚µãƒ¼ãƒ“ã‚¹ã§ `readyAt` ã‚’æ›´æ–°ã™ã‚‹ã®ã¿ã€‚ |
| `delivered` | `"delivered"` | é…é”æ¸ˆã¿ | enum ã«ã¯å­˜åœ¨ã™ã‚‹ãŒãƒ•ãƒ­ãƒ³ãƒˆã‹ã‚‰å‚ç…§ã•ã‚Œã¦ã„ãªã„ã€‚ |
| `completed` | `"completed"` | å®Œäº† | æ³¨æ–‡å±¥æ­´ã§ã¯ã€Œå®Œäº†ã€ã€‚æ³¨æ–‡çŠ¶æ³ã§ã¯ã€Œæä¾›æ¸ˆã¿ã€ã¨ã—ã¦è¡¨ç¤ºã€‚ |
| `cancelled` | `"canceled"` | ã‚­ãƒ£ãƒ³ã‚»ãƒ« | æ³¨æ–‡å±¥æ­´ã®ãƒ•ã‚£ãƒ«ã‚¿å¯¾è±¡ã€‚ |
| `refunded` | `"refunded"` | è¿”é‡‘æ¸ˆã¿ | æ³¨æ–‡å±¥æ­´ã®ãƒ•ã‚£ãƒ«ã‚¿å¯¾è±¡ã€‚ |

## 4. ç”»é¢ã”ã¨ã®æŒ™å‹•

### 4.1 æ³¨æ–‡å±¥æ­´ (`order_history_page.dart`)

- `OrderHistoryViewData.status` ã®å€¤ã‚’ãã®ã¾ã¾ `_OrderStatusBadge` ã«æ¸¡ã—ã€`OrderStatus.displayName` ã‚’è¡¨ç¤ºã€‚
- ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãƒ•ã‚£ãƒ«ã‚¿ (`OrderHistoryState.selectedStatusFilter`) ã¯ `completed / cancelled / refunded` ã®ã¿ã‚’å¯¾è±¡ã¨ã—ã¦ãŠã‚Šã€
  `confirmed` ã‚„ `preparing` ã¯ã€Œå…¨ã¦ã€æ‰±ã„ã€‚
- ãã®çµæœã€å±¥æ­´ä¸€è¦§ã«ã¯ã€Œæº–å‚™ä¸­ã€ã€Œç¢ºèªæ¸ˆã¿ã€ã€Œå®Œäº†ã€ãªã© enum ã®è¡¨ç¤ºåãŒæ··åœ¨ã™ã‚‹ã€‚

### 4.2 æ³¨æ–‡çŠ¶æ³ (`order_status_page.dart`)

- UI ã‚»ã‚¯ã‚·ãƒ§ãƒ³åã‚’ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã§ `"æº–å‚™ä¸­"` / `"æä¾›æ¸ˆã¿"` ã¨å®šç¾©ã€‚
- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ© (`OrderStatusController.loadOrders`) ã¯ `OrderService.getOrdersByStatuses` ã« `preparing` ã¨ `completed` ã®ã¿ã‚’æŒ‡å®šã€‚
- å®Œäº†ãƒœã‚¿ãƒ³ (`æä¾›æ¸ˆã¿ã«ã™ã‚‹`) ã¯ `updateOrderStatus(order.id, OrderStatus.completed, â€¦)` ã‚’å‘¼ã³å‡ºã—ã€ãƒˆãƒ¼ã‚¹ãƒˆã‚‚ "æä¾›æ¸ˆã¿" ã‚’ä½¿ç”¨ã€‚
- `OrderStatus.completed.displayName` ãŒã€Œå®Œäº†ã€ã§ã‚ã‚‹ãŸã‚ã€å±¥æ­´ç”»é¢ã¨ã¯ç”¨èªãŒä¸€è‡´ã—ã¦ã„ãªã„ã€‚

## 5. ã‚µãƒ¼ãƒ“ã‚¹å±¤ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é·ç§»

- `OrderManagementService.checkoutCart` (`order_management_service.dart` L108-L167):
  - ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å¾Œã€æ³¨æ–‡ã® `status` ã‚’ `OrderStatus.confirmed` ã«æ›´æ–°ã€‚
  - ãã®ã¾ã¾ `OrderHistoryController` ã§ã¯ã€Œç¢ºèªæ¸ˆã¿ã€ã¨è¡¨ç¤ºã•ã‚Œã‚‹ãŒã€`OrderStatusController` ã®å–å¾—å¯¾è±¡å¤–ã€‚
- `OrderManagementService.updateOrderStatus` (L362-L413):
  - `preparing` ã¨ `completed` ã¸ã®æ›´æ–°ã®ã¿ã‚µãƒãƒ¼ãƒˆã€‚
  - `completed` ã¸é·ç§»ã™ã‚‹éš›ã« `completed_at` ã‚’æ›´æ–°ã€‚`delivered` ç­‰ã¯æœªä½¿ç”¨ã€‚
- `KitchenOperationService` ç³»:
  - ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ³¨æ–‡ã¯ `OrderStatus.preparing` ã®ã¿ã‚’å¯¾è±¡ã¨ã—ãŸãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹ãŒä¸­å¿ƒã€‚
  - `deliverOrder` ã§ `status = completed` ã«è¨­å®šã—ã¦ã„ã‚‹ãŒã€UI ã¨ã¯ç´ä»˜ã„ã¦ã„ãªã„ (ç¾æ™‚ç‚¹ã§ã¯å‘¼ã³å‡ºã—å…ƒä¸æ˜)ã€‚

## 6. ä¸æ•´åˆãƒã‚¤ãƒ³ãƒˆ

1. **ç¿»è¨³ã®æºã‚‰ã**: `OrderStatus.completed` ã¯ `displayName = "å®Œäº†"` ã ãŒã€æ³¨æ–‡çŠ¶æ³ãƒšãƒ¼ã‚¸ã§ã¯ã€Œæä¾›æ¸ˆã¿ã€ã¨è¡¨è¨˜ã—ã¦ã„ã‚‹ã€‚
2. **ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ç²’åº¦ã®å·®ç•°**: å±¥æ­´ã¯å…¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ‰±ã†ä¸€æ–¹ã€çŠ¶æ³ãƒšãƒ¼ã‚¸ã¯ `preparing` / `completed` ã®äºŒæ®µéšã«ç¸®ç´„ã—ã¦ã„ã‚‹ã€‚
3. **`confirmed` ã®å­¤ç«‹**: Checkout ç›´å¾Œã®æ³¨æ–‡ã¯ `confirmed` ã®ã¾ã¾ã§ã€çŠ¶æ³ãƒšãƒ¼ã‚¸ã«è¡¨ç¤ºã•ã‚Œãªã„ã€‚`preparing` ã¸é·ç§»ã•ã›ã‚‹å°ç·šãŒ UI / ã‚µãƒ¼ãƒ“ã‚¹ã¨ã‚‚ã«æœªè¨­è¨ˆã€‚
4. **æœªä½¿ç”¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®å­˜åœ¨**: `ready` ã‚„ `delivered` ã® enum ãŒå®šç¾©ã•ã‚Œã¦ã„ã‚‹ãŒã€å‰æ®µã®ç”»é¢ã§ã¯åˆ©ç”¨ã•ã‚Œã¦ãŠã‚‰ãšã€æ¦‚å¿µãŒå®™ã«æµ®ã„ã¦ã„ã‚‹ã€‚

## 7. å½±éŸ¿ã¨ãƒªã‚¹ã‚¯

- ã‚ªãƒšãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³ä¸Šã€ã€Œæä¾›æ¸ˆã¿ã€ã¨ã€Œå®Œäº†ã€ã®æ··åœ¨ã«ã‚ˆã‚Šã‚¹ã‚¿ãƒƒãƒ•é–“ã§ã®ç”¨èªé½Ÿé½¬ãŒç™ºç”Ÿã™ã‚‹æã‚Œã€‚
- `confirmed` çŠ¶æ…‹ã®æ³¨æ–‡ãŒçŠ¶æ³ç”»é¢ã«ç¾ã‚Œãªã„ãŸã‚ã€ä¼šè¨ˆç›´å¾Œã®æ³¨æ–‡ãŒã‚­ãƒƒãƒãƒ³ãƒœãƒ¼ãƒ‰ã«è¡¨ç¤ºã•ã‚Œãšè¦‹è½ã¨ã™ãƒªã‚¹ã‚¯ãŒã‚ã‚‹ã€‚
- ä»Šå¾Œ `delivered` ãªã©ã‚’å°å…¥ã™ã‚‹å ´åˆã€æ—¢å­˜ UI ã¨ã®ç”¨èªæ•´åˆã‚’å–ã‚‰ãªã„ã¨ã•ã‚‰ãªã‚‹æ··ä¹±ã‚’æ‹›ãã€‚

## 8. ä»Šå¾Œã®æ¤œè¨æ¡ˆ

- `OrderStatus` ã®æ—¥æœ¬èªè¡¨è¨˜ã‚’å˜ä¸€ã‚½ãƒ¼ã‚¹ã§ç®¡ç†ã™ã‚‹ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£åŒ–ã€ã‚‚ã—ãã¯ UI å´ã®ãƒãƒ¼ãƒ‰ã‚³ãƒ¼ãƒ‰ã‚’æ’é™¤ã€‚
- Checkout å¾Œã« `confirmed â†’ preparing` ã¸é·ç§»ã•ã›ã‚‹ãƒˆãƒªã‚¬ãƒ¼ã‚’è¿½åŠ ã—ã€ã‚­ãƒƒãƒãƒ³ç”»é¢ã¨å±¥æ­´ã®è¡¨ç¤ºæ•´åˆã‚’å›³ã‚‹ã€‚
- `completed` ã¨ `delivered` ã®å½¹å‰²ã‚’å®šç¾©ã—ç›´ã—ã€å¿…è¦ã§ã‚ã‚Œã°æ³¨æ–‡çŠ¶æ³ç”»é¢ã®ã‚»ã‚¯ã‚·ãƒ§ãƒ³æ§‹æˆã‚’å†æ¤œè¨ (ä¾‹: ç¢ºèªå¾…ã¡ / èª¿ç†ä¸­ / æä¾›æº–å‚™å®Œäº† / æä¾›æ¸ˆã¿)ã€‚
- æœªä½¿ç”¨ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ (`ready`, `delivered`) ã®æ‰±ã„æ–¹é‡ã‚’æ±ºã‚ã€ä¸è¦ã§ã‚ã‚Œã° enum ã‹ã‚‰é™¤å¤–ã™ã‚‹ã‹ ğŸš§ ã®æ³¨è¨˜ã‚’è¿½åŠ ã™ã‚‹ã€‚
