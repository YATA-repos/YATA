# 注文番号フォーマット変更影響調査

- 日付: 2025-09-30
- 作成者: GitHub Copilot
- 目的: 案A（`orderNumber` をカート作成時に短い表示用コードへ置き換える）を実施するにあたり、既存画面が `orderNumber` に依存している箇所と、フォーマット変更による影響を洗い出す。

## 1. 対象範囲

- Flutter UI（注文関連画面）
- 表示用 ViewModel / Controller レイヤー
- 検索やフィルタなど `orderNumber` を直接参照するロジック

バックエンド・テストコードについても、フォーマット依存が強いものは備考に記載した。

## 2. 画面別の参照状況と影響

| 画面 / 機能 | ファイル | `orderNumber` 利用箇所 | フォーマット変更による影響 | 備考 |
| --- | --- | --- | --- | --- |
| 注文管理ページ（カート画面） | `order_management_page.dart` | `_OrderNumberBadge` が現在のカート番号を表示。会計完了スナックバーで確定注文番号を表示。 | **低**: 文字列をそのまま表示しているだけで、特定フォーマットを前提とした処理なし。短いコードに置き換えても問題なし。 | 会計直後は確定注文番号をメッセージに埋め込む。新フォーマットでも可読性を確保したい。 |
| 注文状況ページ（進行中／完了／キャンセル） | `order_status_page.dart` + `order_status_controller.dart` | リストカードのヘッダに `orderNumber` を表示。完了操作時のスナックバー文言にも使用。 | **低**: 表示テキストのみ。短いコードでも UI 上問題なし。 | 未設定時は "注文番号未設定" を表示するハンドリングあり。 |
| 注文履歴ページ（一覧・詳細） | `order_history_page.dart` + `order_history_controller.dart` | 一覧カード、詳細モーダルで表示。検索フィルタ時に `orderNumber` 文字列に `contains` を行う。 | **中（注意）**: 表示は問題なし。検索は小文字化して部分一致する実装のため、英数字のみの短いコードでも動作するが、ユーザーが識別しやすいフォーマットを設計する必要あり。 | 検索 Placeholder (`"注文番号、顧客名、メニュー名で検索..."`) はそのままで可。 |

## 3. UI 以外での補足

| レイヤー | ファイル | 依存内容 | フォーマット変更への考慮 |
| --- | --- | --- | --- |
| リポジトリ | `order_repository.dart` | `findActiveDraftByUser` が `order_number IS NULL` を条件にカートを特定。 | カート生成時に番号を付与する場合、この条件を変更する必要がある（例: `is_cart = true` のみに絞る／別カラムを利用）。 |
| サービス | `order_management_service.dart` | `checkoutCart` が毎回 `generateNextOrderNumber()` を呼んで正式番号を再発行。 | 案Aでは「既に番号がある場合は再発行しない」分岐が必要。 |
| テスト | `order_identifier_generator_test.dart` ほか | 現行フォーマット（`YYYYMMDDThhmmss+0900-Base62`）を前提に期待値を記述。 | 新フォーマット導入時は該当テスト群を刷新する。 |

## 4. まとめと次アクション

- UI で `orderNumber` を表示しているのは「注文管理」「注文状況」「注文履歴」の3画面。いずれも文字列表示のみのため、短い表示コードへ変更しても致命的な影響はなし。
- `order_history_controller.dart` の検索処理は大小文字を同一視するため、英数字コードでも検索可能。ただし、ユーザーが入力しやすいフォーマット（例: 英大文字 + 数字）を検討すると運用上の混乱を避けられる。
- 案Aを成立させるには、リポジトリ＆サービス層の `order_number` null 前提ロジックを改修するのが必須。UI 改修と並行して設計を進める。
- テストおよび既存ドキュメント（番号形式を説明している資料）がある場合は、フォーマット変更後に追従が必要。

### 推奨ステップ

1. 表示用コードのフォーマット案決定（例: `ORD-XXXXXX`）。
2. リポジトリ／サービスのカート判定ロジック更新方針を設計。
3. UI 表示テキスト（ラベル名など）がフォーマット変更に沿っているか確認。
4. 実装後、注文履歴検索、注文状況更新、会計完了通知など主要シナリオでコード表示を手動確認。
